<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    {% load static %}
    {% load project_templates %}
    <room-details charset="utf-8" />
    <room-details name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css" />
    <link rel="stylesheet" href="{% static 'app/content/tagify.css' %}" />
    <link rel="stylesheet" href="{% static 'app/content/tags.css' %}" />
    <link rel="stylesheet" href="{% static 'app/content/chatPage.css' %}" />
    <link rel="stylesheet"
        href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" type="text/css"
        rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'app/content/style.css' %}" />

    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="{% static 'app/scripts/jquery.js' %}"></script>

    <script src="{% static 'app/scripts/jquery.ui.widget.js' %}"></script>
    <script src="{% static 'app/scripts/jquery.iframe-transport.js' %}"></script>
    <script src="{% static 'app/scripts/jquery.fileupload.js' %}"></script>

    <script src="{% static 'app/scripts/tag.js' %}"></script>
    <script src="{% static 'app/scripts/jQuery.tagify.min.js' %}"></script>
    <script>
        // if IE, add IE tagify's polyfills
        !(function (d) {
            if (!d.currentScript) {
                var s = d.createElement("script");
                s.src = "{% static 'app/scripts/tagify.polyfills.min.js' %}";
                d.head.appendChild(s);
            }
        })(document);
    </script>
    <style>
        body {
            margin: 40px 10px;
            padding: 0;
            font-family: Helvetica;
            font-size: 14px;
        }

        .customSuggestionsList>div {
            min-height: 300px;
            max-height: 300px;
            border: 2px solid lightblue;
            overflow: auto;
            margin: 5%;
            border-radius: 5px;
            box-shadow: 0 4px 8px 0 rgb(0 0 0 / 20%), 0 6px 20px 0 rgb(0 0 0 / 19%);
        }

        .rooms-containter::-webkit-scrollbar {
            width: 8px;
            background: #2c3e50;
        }

        .rooms-containter::-webkit-scrollbar-thumb {
            background-color: #243140;
        }

        .rooms-containter ul li.room-link .wrap {
            width: 88%;
            margin: 0 auto;
            position: relative;
        }

        .room-details {
            display: flow-root;
            margin-left: 55px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .rooms-containter ul li.room-link .wrap span {
            position: absolute;
            left: 0;
            margin: -2px 0 0 -2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid #2c3e50;
            background: #95a5a6;

        }

        .room-details {

            overflow: hidden;
            margin-right: 30px;

        }

        .preview {

            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            -moz-transition: 1s all ease;
            -o-transition: 1s all ease;
            -webkit-transition: 1s all ease;
            transition: 1s all ease;
        }

        /*.rooms-containter ul li.room-link .wrap .room-details .preview span {
            position: initial;
            border-radius: initial;
            background: none;
            border: none;
            padding: 0 2px 0 0;
            margin: 0 0 0 1px;
            opacity: .5;
        }*/

        .wrap img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: inline-flex;
            flex-direction: row;
        }

        #avatars img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: inline-flex;
            flex-direction: row;
        }

        .avatars {
            position: relative;
            display: inline-flex;
            /* width: 40px; */
            float: left;
            /* margin-left: 0px; */
            /* margin-right: auto; */
            justify-content: center;
            margin-top: 10px;
            margin-bottom: 10pc;
        }

        .user-header #title-img {
            width: 50px;
            border-radius: 50%;
            margin-top: 1%;
            padding: 2px;
            height: auto;
            float: left;
            cursor: pointer;
            -moz-transition: 0.3s border ease;
            -o-transition: 0.3s border ease;
            -webkit-transition: 0.3s border ease;
            transition: 0.3s border ease;
            display: none;
        }

        .room-link {
            position: relative;

            font-size: 0.9em;
            cursor: pointer;
            height: 80px;
            max-height: 80px;
            min-height: 80px;
            text-overflow: ellipsis;
        }

        .name-of-room {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .ellipsis {
            position: relative;
            float: right;
            bottom: 50px;
            font-size: 25px;
            cursor: pointer;
            display: block;

        }

        .rightPanel {
            height: 250px;
            overflow-y: scroll;
        }

        .remove-button {
            border-radius: 20%;
            font-size: 25px;
            position: relative;
            cursor: pointer;
            float: right;
            right: 2.5px;
        }

        .remove-button:hover {
            background-color: lightblue;
            color: blue;
        }


        /*.ellipsis:hover,
        .ellipsis:focus {
            background-color: #2980B9;
        }*/

        .chat-dropdown-content {
            display: none;
            position: absolute;
            background-color: WHITE;
            width: 160px;
            overflow: auto;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 5;
            left: 200px;

        }

        .chat-dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .chat-dropdown {
            position: relative;
            display: inline;
            bottom: 15px;
            z-index: 5;
        }

        .chat-dropdown a:hover {
            background-color: #ddd;
        }

        .confirmation-modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 2;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
            padding-top: 60px;
            overflow: hidden;
        }

        /* Modal Content/Box */
        #confirmation-page {
            background-color: #fefefe;
            margin: 5% auto 15% auto;
            /* 5% from the top, 15% from the bottom and centered */
            border: 1px solid #000;
            width: 30%;
            height: 30%;
            z-index: 3;
            border-radius: 5px;
            margin-right: 33%;
            /* Could be more or less, depending on screen size */
            box-shadow: 0 4px 8px 0 rgb(0 0 0 / 20%), 0 6px 20px 0 rgb(0 0 0 / 19%);
            overflow: hidden;
        }

        .edit-chat-modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 2;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
            padding-top: 60px;
            overflow: hidden;
        }

        /* Modal Content/Box */
        #change-name-page {
            background-color: #fefefe;
            margin: 5% auto 15% auto;
            /* 5% from the top, 15% from the bottom and centered */
            border: 1px solid #000;
            width: 40%;
            height: 45%;
            z-index: 3;
            border-radius: 5px;
            margin-right: 27%;
            /* Could be more or less, depending on screen size */
            box-shadow: 0 4px 8px 0 rgb(0 0 0 / 20%), 0 6px 20px 0 rgb(0 0 0 / 19%);
            overflow: hidden;
        }

        #confirmation-removal-page {
            background-color: #fefefe;
            margin: 5% auto 15% auto;
            /* 5% from the top, 15% from the bottom and centered */
            border: 1px solid #000;
            width: 30%;
            height: 30%;
            z-index: 3;
            border-radius: 5px;
            margin-right: 33%;
            /* Could be more or less, depending on screen size */
            box-shadow: 0 4px 8px 0 rgb(0 0 0 / 20%), 0 6px 20px 0 rgb(0 0 0 / 19%);
            overflow: hidden;
        }

        .confirmation-chat-modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 2;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
            padding-top: 60px;
            overflow: hidden;
        }

        #add-members {
            position: absolute;
            /*left: 630px;*/
            left: 93%;
            font-size: xx-large;
            bottom: 13px !important;
            display: none;
        }

        a {
            color: #21B5B7
        }

        .incoming-msg-img {
            float: left;
            width: 6%;
        }

        .outgoing-msg-img {
            float: right;
            width: 2%;
            padding-left: 5px;
        }

        .chat-wrapper {
            display: inline-block;
            clear: both;
            width: calc(100% - 25px);
            font-size: 0.9em;
        }

        .file_image {
            display: inline;
        }
    </style>
</head>

<!-- Make it autocomplete or somehting like that so not all users
show in the dropdown. Maybe an onChange functionality. Make it so dropdown
is empty when first clicked -->

<!--

-->

<body>
    <div class="sidebar">


        <div class="sidebar-menu">
            <ul>
                <li>
                    <a href="{% url 'dashboard' %}">
                        <span id="fist-element" class="las la-home"></span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'resourcedirectory' %}">
                        <span class="las la-book"></span>
                    </a>
                </li>
                <li>
                    <a class="active" href="{% url 'multichat' %}">
                        <span class="las la-comment-alt"></span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'clientlist' %}">
                        <span class="las la-user-friends"></span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'userinfo' %}">
                        <span class="las la-plus-circle"></span>
                    </a>
                </li>
            </ul>
        </div>
    </div>



    <header class="dash-header">

        <div class="sidebar-header">
            <span id="sidebar-toggle" class="las la-bars"></span>
        </div>
        <div id="leftside">
            <div class="search-wrapper">
                <span class="las la-search"></span>
                <input type="search" placeholder="Search here" />
            </div>
            <div class="vl"></div>
            <div class="dropdown">
                <div class="user-wrapper">
                    <div class="user-wrapper">
                        <a href="{% url 'profile' %}">
                            <div class="profile-pic-wrapper" data-username="{{user.username}}"
                                data-bgcolor="{{user.bgColor}}">
                                {% if user.avatar %}
                                <img class="profile-pic" src="{{user.avatar.url}}">
                                {% endif %}
                            </div>
                        </a>
                        <i id="caret-icon" style=font-size:25px;color:white;float:right; class="las la-angle-down"></i>
                        <div class="dropdown-content">
                            <div id="usermenu">
                                {% if user.id in userlist %}
                                {% for back in background %}
                                {% if back.user_id == user.id %}
                                <h3>{{ back.firstname }} {{ back.lastname }}</h3>
                                {% endif %}
                                {% endfor %}
                                {% else %}
                                <h3>{{ user.username }}</h3>
                                {% endif %}
                                {% if request.user|has_group:"caseworker" %}
                                <h4>Caseworker</h4>
                                {% elif request.user|has_group:"client" %}
                                <h4>Client</h4>
                                {% else %}
                                <h4>Not implemented</h4>
                                {% endif %}
                            </div>
                            <a href="{% url 'logout' %}">Log out</a>
                        </div>
                    </div>
                </div>
            </div>
    </header>

    <div class="main-content">
        <div class="chat-container">
            <div class="left-panel">
                <div class="left-panel-header">
                    <div class="search-container">
                        <input id="myInput" type="text" placeholder="Search.." name="search" onkeyup="SearchFunction()">
                    </div>
                </div>
                <div class="rooms-container">
                    <p style="color:#015D67; font-weight: bold; font-size: large;margin-left: 5%;">
                        Current Client
                        Chats</p>
                    <hr>
                    <ul id="rooms" class="rooms" style="height: 100%;">
                    </ul>
                </div>
                <div class="creating-chat-section">
                    <button style="margin-top: 3.3%;" id="create-chat"><strong>Open New Chat </strong><i style="  float: right;
                        font-size: 30px;
                        color: #015D67;
                        font-weight: bold;
                        margin: 0;
                        position: absolute;
                        top: 50%;
                        left: 90%;
                        -ms-transform: translate(-90%, -50%);
                        transform: translate(-90%, -50%);" class="las la-plus-circle"></i></button><br />
                </div>
            </div>
            <div class="middle-panel">
                <div class="user-header">
                    <section id="users-list"
                        style="display: none; position: relative; background-color: #fff; bottom: 3px;">
                        <p>
                            <input id="tag-input" style="display: none; position: relative; background-color: #fff;"
                                name="users-list-tags" />
                        </p>
                    </section>
                    <div class="title-wrap" style="display: inline;margin-top:10px">
                        <b>
                            <div class="avatars" id="avatars" style="margin-left: 10px;"></div>
                            <p class="room-title"
                                style=" width: 50%; color:#015D67; font-weight: bold; font-size: large; overflow:hidden; white-space: nowrap;text-overflow:ellipsis;margin-left: 65px;">
                            </p>
                        </b>
                        <i id="add-members" class="las la-plus-circle" style="color:#015D67;cursor: pointer;"></i>
                    </div>
                </div>

                <div class="chat-log" style="width: 100%;">
                    <div class="chat-messages"></div>
                </div>
                <div class="input-section">
                    <input id="fileupload" type="file" name="file" multiple style="display: none"
                        data-url="{% url 'upload' %}" data-form-data='{"csrfmiddlewaretoken": "{{ csrf_token }}"}' />
                    <form class="sending-form">
                        <input type="text" style="display: none;margin-top: 4%;" id="typed_msg"
                            placeholder="Type a message" name="chat-message" required />
                        <i id="upload-photos-button" class="las la-paperclip"
                            style="display:none;cursor:pointer;font-size:25px;margin-top: 5%;"></i>
                        <button class="msg_send_btn" style="display: none;" type="submit"><i style="color: white;"
                                class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
                    </form>
                </div>
            </div>
            <div class="right-panel">
                <button class="rightAccordion" style="display: none;">Members</button>
                <div class="rightPanel">

                    <ul class="right-btn-group">
                        <li class="list-of-members">

                        </li>
                    </ul>
                </div>
                <button class="rightAccordion">Files</button>
                <div class="rightPanel">
                    <ul class="right-btn-group">
                        <li class="list-of-files">

                        </li>
                    </ul>
                </div>

                <button class="rightAccordion">Links</button>
                <div class="rightPanel">
                    <ul class="right-btn-group">
                        <li class="list-of-links">

                        </li>
                    </ul>
                </div>
                <script src="{% static 'app/scripts/rightChat.js' %}"></script>
            </div>
        </div>
    </div>
</body>
<input id="myself" type="hidden" value="{{request.user.username}}" />
<br />

<div id="members-page">

    <div id="members-page-content">
        <header>
            <div><span style="padding-left: 5%;font-size:x-large;">Add Members</span>
                <i class="las la-window-close" style="right:0; height: 10%; float:right; position: relative;"
                    onclick="document.getElementById('members-page').style.display='none'" id="close"
                    title="Close Modal"></i>
            </div>
            <div><span class="room-name" style="padding-left: 5%;font-size:large;"></span></div>

        </header>

        <div>
            <section id="section-manual-suggestions">
                <input style="margin-left: 5%;" name='tags-manual-suggestions' placeholder='Search Users'
                    id="user-input">
            </section>

            <div>
                <p style="margin-left: 5%;">
                    <strong>Privacy</strong> <br>
                    - External users cannot be added <br>
                    - New members will see previous messages and files
                </p>
            </div>
        </div>
        <footer style="margin-top: 1%; float: right; margin-right: 5%">
            <span>
                <button id="submit-users" type="button" class="btn btn-primary" disabled>Add Users</button>
                <button type="button" class="btn btn-outline-secondary" name='cancel' id="canc">Cancel</button>
            </span>
        </footer>
    </div>
</div>
<div class="confirmation-modal">
    <div id="confirmation-page">
        <div>
            <p style="margin-left: 5%; padding-top: 5%">
                <strong>Remove User</strong> <br>
            <p style="margin-left: 5%; padding-top: 2%">
                Are you sure you wish to remove this user? <br>
                They will no longer be a member of this chat. <br>
            </p>
            </p>
        </div>
        <span style="margin-top: 5%; float: right; margin-right: 5%">
            <button id="confirm" type="button" class="btn btn-primary">Confirm</button>
            <button type="button" class="btn btn-outline-secondary" id="exit-member-removal">Cancel</button>
        </span>
    </div>
</div>

<div class="confirmation-chat-modal">
    <div id="confirmation-removal-page">
        <div>
            <p style="margin-left: 5%; padding-top: 5%">
                <strong>Remove Chat</strong> <br>
            <p style="margin-left: 5%; padding-top: 2%">
                Are you sure you wish to delete this chat? <br>
                You will no longer be a member of this chat <br>
                and you will no longer have access to past messages.
            </p>
            </p>
        </div>
        <span style="margin-top: 5%; float: right; margin-right: 5%">
            <button id="confirmation" type="button" class="btn btn-primary">Confirm</button>
            <button type="button" class="btn btn-outline-secondary" id="reverse">Cancel</button>
        </span>
    </div>
</div>
<div class="edit-chat-modal">
    <div id="change-name-page">
        <h3 style="margin-left: 5%;margin-top: 5%;">Edit Chat Name</h3>

        <p style="margin-left: 5%;">
            <input style="    padding: 6px;
            margin-top: 5%;
            font-size: 17px;
            border-style: solid;
            border-width: 1px;
            border-radius: 5px;
            border-color: #afafaf;
            width: 95%;
            position: relative;
            height: 60%;" type="text" placeholder="New Name..." name='new-chat-name' id="chatName"
                onkeyup="onChangeName()" maxlength="100" />

        </p>
        <div>
            <p style="margin-left: 5%; padding-top: 5%;">
                <strong>Notice</strong> <br>
                - Can not name room the same as another <br>
                - Chat name can not be changed back
            </p>
        </div>

        <span style="margin-top: 5%; float: right; margin-right: 5%">
            <button id="confirmation-of-name" type="button" class="btn btn-primary" disabled>Confirm</button>
            <button type="button" class="btn btn-outline-secondary" id="cancel-name">Cancel</button>
        </span>
    </div>

</div>


<audio id="chatAudio">
    <source src="{% static 'app/audio/notification.mp3' %}" type="audio/mpeg">
</audio>
<script src="https://cdnjs.cloudflare.com/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.min.js"
    integrity="sha512-B4skI5FiLurS86aioJx9VfozI1wjqrn6aTdJH+YQUmCZum/ZibPBTX55k5d9XM6EsKePDInkLVrN7vPmJxc1qA=="
    crossorigin="anonymous"></script>
<script src="{% static 'app/scripts/default_avatar.js' %}"></script>


<script>

    $("#caret-icon").on('click', function () {
        $(this).toggleClass('la-angle-up la-angle-down');
        $(".dropdown-content").toggle('show hide');
    })

    $("#sidebar-toggle").on('click', function () {
        $(".sidebar").toggle('show hide');
    })
</script>
<script>
    let roomId = false;
    let nameofmembers = [];
    var whitelist_2 = [];
    var xisweird = 0;
    var y = 0;
    var z = 0;
    let member = false;
    var memberlist = [];
    let tagger = document.getElementById('user-input');
    let inRoom = false;
    let groupName = false;
    let allRooms = [];
    let createroom = false;
    let socketopen = 0;
    let text_changed = false;
    let link = [];
    let typedmessage = null;
    let found = null;
    var prefix = 'https://';
    let ellipsisClicked = false;
    let hideellipsis = false;
    let removeduser = null;
    var allnewusers = [];
    let emptyroom = false;
    var newChat = document.getElementById('chatName');
    let avatararray = [];
    let arrayofusers = [];
    let a = 0;

    function onChangeName() {
        if (newChat.value != 0) {
            document.getElementById('confirmation-of-name').disabled = false;
        } else {
            document.getElementById('confirmation-of-name').disabled = true;
        }

        /*
        function onChangeName() {
        alphanumeric = new RegexValidator(r'^[0-9a-zA-Z]*$')
        search_input = $("#myInput")[0];
        var filter = newChat.value.toUpperCase();
        for (i = 0; i < filter.length; i++) {
            if (filter[i] is not in alphanumeric) {
                error modal pops up saying only alphanumerics are allowed and show examples of incorrect output
                document.getElementById('confirmation-of-name').disabled = true;
            } else{
                if (newChat.value != 0) {
                    document.getElementById('confirmation-of-name').disabled = false;
                }
                else {
                    document.getElementById('confirmation-of-name').disabled = true;
                }
            }
        }
    }
        */
    }


    function SearchFunction() {
        if (hideellipsis) {
            $("[chat-dropdown-value=" + chatDropdownId + "]").hide();
            hideellipsis = false;
        }

        search_input = $("#myInput")[0];
        var filter = search_input.value.toUpperCase();
        var ul = document.getElementById("rooms");
        var li = ul.getElementsByClassName("room-link");
        for (i = 0; i < li.length; i++) {
            var a = li[i].getElementsByTagName("span")[0];
            var txtValue = a.textContent || a.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                li[i].style.display = "";
            } else {
                li[i].style.display = "none";
            }
        }
    }

    $(function () {

        // Correctly decide between ws:// and wss://
        var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        var ws_path = ws_scheme + "://" + window.location.host + "/chat/stream/";
        console.log("Connecting to " + ws_path);

        //var socket = new WebSocket(ws_path);
        var socket = new ReconnectingWebSocket(ws_path);
        var roomName = null;
        var title = null;

        function validateForm() {
            if (inputElm.val() < 1) {
                alert("users must be chosen");
                return false;
            }
        }

        function urlify(typedmessage) {
            var pattern = new RegExp("([a-zA-Z0-9]+://)?([a-zA-Z0-9_]+:[a-zA-Z0-9_]+@)?([a-zA-Z0-9.-]+\\.[A-Za-z]{2,4})(:[0-9]+)?(/.*)?", "g")

            return typedmessage.replace(pattern, function (url) {
                found = typedmessage.match(pattern);
                if (found != null) {
                    var s = typedmessage;
                    if (s.substr(0, prefix.length) !== prefix) {
                        s = prefix + s;
                    }
                    else {
                        s = url;
                    }
                    link = found;
                    text_changed = true;
                    found = null;
                    return '<a href="' + s + '">' + url + '</a>';
                }
                else {
                    text_changed = false;
                    return typedmessage;
                }


            })
            // or alternatively
            // return text.replace(urlRegex, '<a href="$1">$1</a>')
        }



        // Close the dropdown if the user clicks outside of it
        window.onclick = function (event) {
            if (!event.target.matches('#ellipsis')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                var i;
                for (i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }



        function extractify(text) {
            var pattern = new RegExp("([a-zA-Z0-9]+://)?([a-zA-Z0-9_]+:[a-zA-Z0-9_]+@)?([a-zA-Z0-9.-]+\\.[A-Za-z]{2,4})(:[0-9]+)?(/[^><]*)?", "g")
            //var pattern = new RegExp("([a-zA-Z0-9]+://)?([a-zA-Z0-9_]+:[a-zA-Z0-9_]+@)?([a-zA-Z0-9.-]+\\.[A-Za-z]{2,4})(:[0-9]+)?(/.*)?", "g")
            extract = text.match(pattern);
            return extract;
        }


        $(".sending-form").on("submit", function () {
            typedmessage = document.querySelector('#typed_msg').value;
            var html = urlify(typedmessage);
            if (createroom == false) {
                event.preventDefault();
                if (roomName) {
                    if (text_changed) {
                        socket.send(
                            JSON.stringify({
                                "command": "send",
                                "room": roomName,
                                "message": html,
                                "link": true,
                                "file": false
                            })
                        );
                        $('input[name=chat-message]').val('');
                        for (var i = 0; i < link.length; i++) {
                            found = link[i];
                            $(".list-of-links").append(
                                `<li>
                                    <a href="${found}"><i class="las la-link" style="display: inline;">${html}</i></a>
                                    </li>`
                            );
                        }
                        link = [];
                    }
                    else {
                        socket.send(
                            JSON.stringify({
                                "command": "send",
                                "room": roomName,
                                "message": html,
                                "link": false,
                                "file": false
                            })
                        );
                        $('input[name=chat-message]').val('');
                    }
                }
            }
            else {
                event.preventDefault();
                socket.send(
                    JSON.stringify({
                        "command": "create",
                        "message": html,
                        "newUsers": JSON.parse($("#tag-input").val()),
                        "link": false,
                        "file": false
                    })
                );
                $("#tag-input").hide();
                $("#users-list").hide();
                $("#chat-name").hide();
                $("#tag-input").empty();

                $(".room-link").removeClass('active-room');
                $(".user-header").show();
                $(".user-header p").hide();
                $("#title-img").hide();
                $("#create-chat").show();
                $("#create-chat").show();
                $("#upload-photos-button").hide();
                $("#msg_send_btn").hide();
                $(".rightAccordion").show();
                $("#typed_msg").empty();
                $(".rightAccordion").hide();
                $(".rightPanel").hide();
                $('input[name=chat-message]').val('');
                $("#typed_msg").hide();
                createroom = false;
                return false;
            }
        });

        $("#upload-photos-button").click(function () {
            $("#fileupload").click();
        });

        /* 2. INITIALIZE THE FILE UPLOAD COMPONENT */
        $("#fileupload").fileupload({
            dataType: 'json',
            done: function (e, data2) {  /* 3. PROCESS THE RESPONSE FROM THE SERVER */
                if (data2.result.is_valid) {
                    /*send file to recipient and add a progress bar*/
                    console.log("file uploaded")
                    const message = '<a style=word-wrap:break-word; href="' + data2.result.url + '" target="_blank">' + data2.result.name + '</a>'
                    if (roomName) {
                        socket.send(
                            JSON.stringify({
                                "command": "send",
                                "room": roomName,
                                "message": message,
                                "link": false,
                                "file": true
                            })
                        );
                        /*socket.send(
                            JSON.stringify({
                                "command": "edit",
                                "room": roomName,
                                "message": message,
                                "link": false,
                                "file": true
                            })
                        );*/
                        $(".list-of-files").append(
                            `<li>
                                <a style=word-wrap:break-word; href="${data2.result.url}" target="_blank">${data2.result.name}</a>
        	            </li>`)

                    }
                }

            }
        });

        // Handle incoming messages
        socket.onmessage = function (message) {
            console.log("message", message)
            console.log("Got websocket message " + message.data)
            var data = JSON.parse(message.data);
            console.log("data", data)
            // Handle errors
            if (data.error) {
                alert(data.error);
                return;
            }

            message = data.message


            // Handle joining
            if (data.join) {
                console.log("Joining room " + data.join);
                roomName = data.join;
                title = data.title;

                //   console.log("myself value: " + $("#myself").val() + "data.from_user value: " + message.from_user)

                // Hook up send button to send a message




                //hook up sending files
                /* 1. OPEN THE FILE EXPLORER WINDOW */
                var obj = data.title;
                var extra = ", ";
                var me = $("#myself").val() + extra;
                var comma = obj.replace(/-/g, ', ');
                var new_string = comma.replace(me, "");
                me = extra + $("#myself").val();
                new_string = new_string.replace(me, "");
                new_string = new_string.replace("deleted", "")
                new_string = new_string.replace("removed", "")
                new_string = new_string.replace("additional", "")

                $(".user-header p").html(new_string);

                // Handle leaving
            } else if (data.leave) {
                console.log("Leaving room " + data.leave);
                roomName = null;
                $("#room-" + data.leave).remove();
                $(".user-header").empty();
                $(".chat-messages").empty();

                // Handle getting a message
            } else if (data.message || data.msg_type != 0) {
                var msgdiv = $(".chat-messages");
                var ok_msg = "";



                // msg types are defined in chat/settings.py
                // Only for demo purposes is hardcoded, in production scenarios, consider call a service.
                const LEFT_ROOM = 5;
                switch (data.msg_type) {
                    case 0:
                        // Message

                        let text = (data.message.text) ? data.message.text : data.message;
                        let user = (data.message.from_user) ? data.message.from_user : data.username;
                        let avatarofchatlog = data.message.avatar ? '<img class="profile-pic" src="' + data.message.avatar + '">' : '<div class="profile-pic-wrapper" data-username="' + data.message.from_user + '" data-bgcolor="' + data.message.default + '"></div>'
                        //if statement for where user.username is not equal to data.message.from_user
                        let time = (data.message.sent_at) ? data.message.sent_at : data.sent_at;
                        const cssClass = $("#myself").val() == user ? 'outgoing' : 'incoming';
                        if (data.message.notification && user != '{{user.username}}') {

                            var x = document.getElementById("chatAudio");
                            x.play();
                        }

                        if (cssClass == 'outgoing') {
                            $(".chat-messages").append(
                                `<div class='chat-wrapper'>` +
                                `<div class='outgoing-msg-img'>` + avatarofchatlog + `</div>` +
                                `<div class='${cssClass}'>` +
                                text +

                                `</div>` +
                                `</div>`);
                        } else {
                            $(".chat-messages").append(
                                `<div class='chat-wrapper'>` +
                                `<div class='incoming-msg-img'>` + avatarofchatlog + `</div>` +
                                `<div class='${cssClass}'>` +
                                text +

                                `</div>` +
                                `</div>`);

                        }

                        if (data.message.is_file) {
                            var ext = text.split(".");
                            var extension = ext[ext.length - 1];
                            extension = extension.toLowerCase();
                            if (extension == 'pdf' || extension == 'doc' || extension == 'docx' || extension == 'txt' || extension == 'odt' || extension == 'ppt' || extension == 'pptx' || extension == 'html') {
                                $(".list-of-files").append(
                                    `<li>
            		                <a> 
                                    <span class="file_image"><img id="doc" src="{% static 'app/images/documents.png' %}"></span>` +
                                    text +
                                    `</a>
        	                        </li>`)
                            }
                            else if (extension == 'jpg' || extension == 'png' || extension == 'gif' || extension == 'jpeg') {
                                $(".list-of-files").append(
                                    `<li>
            		                <a> 
                                    <span class="file_image"><img id="pic" src="{% static 'app/images/images.png' %}"></span>` +
                                    text +
                                    `</a>
        	                        </li>`)
                            }
                            else if (extension == 'mov' || extension == 'mp4' || extension == 'wmv' || extension == 'avi' || extension == 'flv' || extension == 'mkv' || extension == 'mpeg') {
                                $(".list-of-files").append(
                                    `<li>
            		                <a> 
                                    <span class="file_image"><img id="vid" src="{% static 'app/images/movies.png' %}"></span>` +
                                    text +
                                    `</a>
        	                        </li>`)
                            }
                            else {
                                $(".list-of-files").append(
                                    `<li>
            		                <a> 
                                    <span class="file_image"><img id="etc" src="{% static 'app/images/file.png' %}"></span>` +
                                    text +
                                    `</a>
        	                        </li>`)
                            }

                        }
                        else if (data.message.is_link) {
                            //extract the url from the message
                            array = extractify(text);
                            var protoclregex = new RegExp("^https?:\/\/");

                            for (var i = 1; i < array.length; i++) {
                                var s = '';
                                s = array[i];
                                var t = array[i];
                                extract = t.match(protoclregex);
                                console.log("the t variable", t, extract);

                                if (!extract) {
                                    s = prefix + s;
                                }
                                theString = array[i];
                                $(".list-of-links").append(
                                    `<li>
            		        <a href="${s}"><i class="las la-link" style="display: inline;">${theString}</i></a>
        	            </li>`)
                            }
                        }
                        break;

                    case 1:
                        // Warning / Advice messages
                        ok_msg =
                            "<div class='contextual-message text-warning'>" +
                            data.message +
                            "</div>";
                        break;
                    case 2:
                        // Alert / Danger messages
                        ok_msg =
                            "<div class='contextual-message text-danger'>" +
                            data.message +
                            "</div>";
                        break;
                    case 3:
                        // "Muted" messages
                        ok_msg =
                            "<div class='contextual-message text-muted'>" +
                            data.message +
                            "</div>";
                        break;
                    /* case 4:
                         // User joined room
                         ok_msg =
                             "<div class='contextual-message text-muted'>" +
                             data.username +
                             " joined the room!" +
                             "</div>";
                         break;
                     case LEFT_ROOM:
                         // User left room
                         ok_msg =
                             "<div class='contextual-message text-muted'>" +
                             data.username +
                             " left the room!" +
                             "</div>";
                         break;*/
                    case "created":
                        var obj = data.name;
                        var extra = ", ";
                        var me = $("#myself").val() + extra;
                        var comma = obj.replace(/-/g, ', ');
                        var new_string = comma.replace(me, "");
                        me = extra + $("#myself").val();
                        new_string = new_string.replace(me, "");

                        let avatardivcreate = ""

                        function avatarhtml(userdata) {
                            let avatar = '<div class="profile-pic-wrapper" data-username="' + userdata.username + '" data-bgcolor="' + userdata.default + '">';
                            if (userdata.avatar) {
                                avatar += '<img class="profile-pic" src="' + userdata.avatar + '">';

                            }
                            avatar += '</div>';
                            //let avatar = userdata.avatar ? '<img class="profile-pic" src="' + userdata.avatar + '">' : '<div class="profile-pic-wrapper" data-username="' + userdata.username + '" data-bgcolor="' + userdata.default + '"></div>'

                            return avatar
                        }
                        for (var i = 0; i < data.avatars.length; i++) {
                            /*<div class="profile-pic-wrapper" data-username="{{user.username}}" data-bgcolor="{{user.bgColor}}">
                            {% if user.avatar %}
                            <img class="profile-pic" src="{{user.avatar.url}}">
                            {% endif %}
                            </div>*/

                            // Only show avatars for the first three users in the chat
                            if (i > 2) {
                                break
                            }
                            avatardivcreate += avatarhtml(data.avatars[i])

                        }

                        avatararray[a] = {
                            "group_avatar": avatardivcreate,
                            "group_id": data.room
                        }
                        a++;

                        let extraUserscreate = data.avatars.length - i;
                        $(".rooms").append(
                            `<li id="room-link" class="room-link" data-room-id="${data.room}" name="${data.room}">
                            <div class="wrap">
                                <div avatar-value="${data.room}" class="avatars">
                                ${avatardivcreate}
                                </div>
                                <div class="room-details">
                                    <span style="overflow: hidden;white-space: nowrap;text-overflow: ellipsis;" room-name-value="${data.room}" class="name-of-room" id="name-of-room">${new_string}</span>
                                    <p message-preview-value="${data.room}" class="preview">${data.message}</p>
                                </div>
                                <span
                                ellipsis-value="${data.room}" id="ellipsis-${data.room}" class="las la-ellipsis-v ellipsis">
                                    </span>
                                <div class="chat-dropdown"> 
                                   
                                    <div chat-dropdown-value="${data.room}" class="chat-dropdown-content">
                                    <a edit-button-value="${data.room}" class="edit-button" id="edit-${data.room}">Edit Name</a>
                                    <a delete-button-value="${data.room}" class="delete-button" id="delete-${data.room}">Delete Room</a>
                                            </div>
                                </div>
                            </div>

                        </li>`);

                        editbuttonclicked(`ellipsis-${data.room}`);
                        menuclicked(`delete-${data.room}`, `edit-${data.room}`);

                        break;
                    case "room_exists":
                        $("li[data-room-id=" + data.room_id + "]").click();
                        ok_msg =
                            "<div class='contextual-message text-muted'>room already exists</div>";
                        break;

                    case "get_members":
                        var people = data.member


                        // $(".avatar-list").append(
                        //`<li><img src="" alt="user" class="profile-photo-lg"></li>`
                        // );

                        if (!people.solitary) {

                            $("#upload-photos-button").show();
                            $(".msg_send_btn").show();
                            $("#typed_msg").show();
                            $("#add-members").show();

                            $(".list-of-members").append(
                                `       <li>
            		        <span class="profile-link">${people.username}<i data-id="${people.id}" id="user-${people.id}"  class="las la-minus remove-button"></i></span>
        	            </li>`

                            );

                            nameofmembers[xisweird] = people.username;
                            xisweird++;

                            /*$(".remove-buttons").append(
                                `<li style="padding-bottom: 18px;"><button data-id="${people.id}" class="remove-user">Remove User</button>
                                    </li>`      //attach user id to remove button
                            );*/

                            removeduserclicked(`user-${people.id}`);
                        }
                        else {
                            $("#upload-photos-button").hide();
                            $(".msg_send_btn").hide();
                            $("#typed_msg").hide();
                            $("#add-members").hide();
                            $(".list-of-members").empty();

                        }
                        break;
                    case "delete_room":
                        removedelement = $("li[data-room-id=" + data.room + "]")[0];
                        var list = document.getElementById("rooms");
                        var obj = data.name;
                        var extra = ", ";
                        var me = $("#myself").val() + extra;
                        var comma = obj.replace(/-/g, ', ');
                        var new_string = comma.replace(me, "");
                        me = extra + $("#myself").val();
                        new_string = new_string.replace(me, "");
                        new_string = new_string.replace("deleted", "")
                        new_string = new_string.replace("removed", "")
                        new_string = new_string.replace("additional", "")
                        if ($("#myself").val() == data.removed_user && roomId == data.room) {

                            socket.send(
                                JSON.stringify({
                                    command: "leave",
                                    room: roomId,
                                })
                            );
                            $("#title-img").hide();
                            $("#typed_msg").hide();
                            $("#upload-photos-button").hide();
                            $(".msg_send_btn").hide();
                            $(".user-header").show();
                            $(".user-header p").hide();
                            $("#create-chat").hide();
                            $("#tag-input").hide();
                            $("#users-list").hide();
                            $("#chat-name").hide();
                            $(".chat-messages").empty();
                            $(".rightAccordion").hide();
                            $(".rightPanel").hide();
                            $("#add-members").hide();

                            list.removeChild(removedelement);
                        }
                        else if ($("#myself").val() == data.removed_user && roomId != data.room) {
                            list.removeChild(removedelement);
                        }

                        else if ($("#myself").val() != data.removed_user) {

                            if (data.edited && roomId == data.room) {
                                $(".list-of-members").empty();
                                socket.send(
                                    JSON.stringify({
                                        command: "members",
                                        room: roomId,
                                    })
                                );
                                socket.send(
                                    JSON.stringify({
                                        command: "join",
                                        room: roomId,
                                    })
                                );
                            }
                            else if (!data.edited && roomId == data.room) {
                                $(".list-of-members").empty();
                                socket.send(
                                    JSON.stringify({
                                        command: "members",
                                        room: roomId,
                                    })
                                );
                                $("[room-name-value=" + data.room + "]").html("");
                                $("[room-name-value=" + data.room + "]").html(new_string);
                                $(".room-title").html("");
                                $(".room-title").html(new_string);
                            }
                            else if (!data.edited && roomId != data.room) {
                                $("[room-name-value=" + data.room + "]").html("");
                                $("[room-name-value=" + data.room + "]").html(new_string);
                            }
                        }
                        menuclicked(`delete-${data.room}`, `edit-${data.room}`);
                        break;
                    case "get_users":

                        var allusers = data.user

                        memberlist[y] = {
                            value: allusers.id,
                            name: allusers.username,
                            email: allusers.email,
                        }
                        y++;

                        console.log("users list", memberlist)
                        break;
                    case "get_additional":

                        //var newTitle = data.adder
                        var list = document.getElementById("rooms");
                        var obj = data.name;
                        var extra = ", ";
                        var me = $("#myself").val() + extra;
                        var comma = obj.replace(/-/g, ', ');
                        var new_string = comma.replace(me, "");
                        me = extra + $("#myself").val();
                        new_string = new_string.replace(me, "");
                        new_string = new_string.replace("deleted", "")
                        new_string = new_string.replace("removed", "")
                        new_string = new_string.replace("additional", "")


                        for (var i = 0; i < nameofmembers.length; i++) {

                            if ($("#myself").val() == nameofmembers[i]) {
                                if (data.edited && roomId == data.room) {
                                    $(".list-of-members").empty();
                                    socket.send(
                                        JSON.stringify({
                                            command: "members",
                                            room: roomId,
                                        })
                                    );
                                }
                                else if (!data.edited && roomId == data.room) {

                                    $("[room-name-value=" + data.room + "]").html("");
                                    $("[room-name-value=" + data.room + "]").html(new_string);
                                    $(".room-title").html("");
                                    $(".room-title").html(new_string);
                                    $(".list-of-members").empty();
                                    socket.send(
                                        JSON.stringify({
                                            command: "members",
                                            room: roomId,
                                        })
                                    );
                                }
                                else if (!data.edited && roomId != data.room) {
                                    $("[room-name-value=" + data.room + "]").html("");
                                    $("[room-name-value=" + data.room + "]").html(new_string);
                                }


                            }
                        }
                        for (var j = 0; j < arrayofusers.length; j++) {
                            if ($("#myself").val() == arrayofusers[i]) {

                                $(".rooms").append(
                                    `<li id="room-link" class="room-link" data-room-id="${data.room}" name="${data.room}">
                                        <div class="wrap">
                                            <div avatar-value="${data.room}" class="avatars">
                                            </div>
                                            <div class="room-details">
                                                <span style="overflow: hidden;white-space: nowrap;text-overflow: ellipsis;" room-name-value="${data.room}" class="name-of-room" id="name-of-room">${new_string}</span>
                                                <p message-preview-value="${data.room}" class="preview">new message</p>
                                            </div>
                                            <span
                                                ellipsis-value="${data.room}" id="ellipsis-${data.room}" class="las la-ellipsis-v ellipsis">
                                                </span>
                                            <div class="chat-dropdown"> 
                                                
                                                <div chat-dropdown-value="${data.room}" class="chat-dropdown-content">

                                                <a edit-button-value="${data.room}" class="edit-button" id="edit-${data.room}">Edit Name</a>
                                                <a delete-button-value="${data.room}" class="delete-button" id="delete-${data.room}">Delete Room</a>
                                                        </div>
                                            </div>
                                        </div>

                                        </li>`);
                            }

                        }
                        editbuttonclicked(`ellipsis-${data.room}`);
                        menuclicked(`delete-${data.room}`, `edit-${data.room}`);
                        break;
                    case "remove_user":

                        //var newTitle = data.adder
                        let old_room = $("li[data-room-id=" + data.room + "]")[0];
                        let old_room_edit_id = $("#edit-" + data.room)[0];
                        let old_room_delete_id = $("#delete-" + data.room)[0];
                        var obj = data.name;
                        var extra = ", ";
                        var me = $("#myself").val() + extra;
                        var comma = obj.replace(/-/g, ', ');
                        var new_string = comma.replace(me, "");
                        me = extra + $("#myself").val();
                        new_string = new_string.replace(me, "");
                        new_string = new_string.replace("deleted", "")
                        new_string = new_string.replace("removed", "")
                        new_string = new_string.replace("additional", "")

                        if ($("#myself").val() == data.removed_user && roomId == data.room) {
                            socket.send(
                                JSON.stringify({
                                    command: "leave",
                                    room: data.room,
                                })
                            );
                            old_room.setAttribute("data-room-id", data.new_room);
                            old_room.setAttribute("name", data.new_room);
                            old_room.setAttribute("room-name-value", data.new_room);
                            old_room.setAttribute("message-preview-value", data.new_room);
                            old_room.setAttribute("ellipsis-value", data.new_room);
                            old_room.setAttribute("chat-dropdown-value", data.new_room);
                            old_room.setAttribute("edit-button-value", data.new_room);
                            old_room.setAttribute("delete-button-value", data.new_room);
                            old_room_edit_id.setAttribute("id", data.new_room);
                            old_room_delete_id.setAttribute("id", data.new_room);
                            socket.send(
                                JSON.stringify({
                                    command: "join",
                                    room: data.new_room,
                                })
                            );
                            $(".list-of-members").empty();
                            socket.send(
                                JSON.stringify({
                                    command: "members",
                                    room: data.new_room,
                                })
                            );
                        }
                        else if ($("#myself").val() == data.removed_user && roomId != data.room) {
                            old_room.setAttribute("data-room-id", data.new_room);
                            old_room.setAttribute("name", data.new_room);
                            old_room.setAttribute("room-name-value", data.new_room);
                            old_room.setAttribute("message-preview-value", data.new_room);
                            old_room.setAttribute("ellipsis-value", data.new_room);
                            old_room.setAttribute("chat-dropdown-value", data.new_room);
                            old_room.setAttribute("edit-button-value", data.new_room);
                            old_room.setAttribute("delete-button-value", data.new_room);
                            old_room_edit_id.setAttribute("id", data.new_room);
                            old_room_delete_id.setAttribute("id", data.new_room);
                        }
                        else if ($("#myself").val() != data.removed_user) {
                            if (data.edited && roomId == data.room) {
                                $(".list-of-members").empty();
                                socket.send(
                                    JSON.stringify({
                                        command: "members",
                                        room: data.room,
                                    })
                                );
                            }
                            else if (!data.edited && roomId == data.room) {
                                $(".list-of-members").empty();
                                socket.send(
                                    JSON.stringify({
                                        command: "members",
                                        room: data.room,
                                    })
                                );
                                $("[room-name-value=" + data.room + "]").html("");
                                $("[room-name-value=" + data.room + "]").html(new_string);
                                $(".room-title").html("");
                                $(".room-title").html(new_string);
                            }
                            else if (!data.edited && roomId != data.room) {
                                $("[room-name-value=" + data.room + "]").html("");
                                $("[room-name-value=" + data.room + "]").html(new_string);
                            }
                        }
                        editbuttonclicked(`ellipsis-${data.new_room}`);
                        menuclicked(`delete-${data.new_room}`, `edit-${data.new_room}`);

                        break;

                    case "get_rooms":
                        roomie = data.rooms;
                        let o = 0;
                        allRooms[o] = roomie.id;
                        o++;

                        var obj = roomie.name;
                        var extra = ", ";
                        var me = $("#myself").val() + extra;
                        var comma = obj.replace(/-/g, ', ');
                        var new_string = comma.replace(me, "");
                        me = extra + $("#myself").val();
                        new_string = new_string.replace(me, "");
                        new_string = new_string.replace("deleted", "")
                        new_string = new_string.replace("removed", "")
                        new_string = new_string.replace("additional", "")
                        let avatardiv = ""
                        console.log("room data", data.rooms);

                        function avatarhtml(userdata) {
                            let avatar = '<div class="profile-pic-wrapper" data-username="' + userdata.username + '" data-bgcolor="' + userdata.default + '">';
                            if (userdata.avatar) {
                                avatar += '<img class="profile-pic" src="' + userdata.avatar + '">';

                            }
                            avatar += '</div>';
                            //let avatar = userdata.avatar ? '<img class="profile-pic" src="' + userdata.avatar + '">' : '<div class="profile-pic-wrapper" data-username="' + userdata.username + '" data-bgcolor="' + userdata.default + '"></div>'

                            return avatar
                        }
                        for (var i = 0; i < data.rooms.avatars.length; i++) {
                            /*<div class="profile-pic-wrapper" data-username="{{user.username}}" data-bgcolor="{{user.bgColor}}">
                            {% if user.avatar %}
                            <img class="profile-pic" src="{{user.avatar.url}}">
                            {% endif %}
                            </div>*/

                            // Only show avatars for the first three users in the chat
                            if (i > 2) {
                                break
                            }
                            avatardiv += avatarhtml(data.rooms.avatars[i])

                        }

                        avatararray[a] = {
                            "group_avatar": avatardiv,
                            "group_id": roomie.id
                        }
                        a++;
                        let extraUsers = data.rooms.avatars.length - i;
                        $(".rooms").append(
                            `<li id="room-link" class="room-link" data-room-id="${roomie.id}" name="${roomie.id}">
                            <div class="wrap">
                                <div avatar-value="${data.room}" class="avatars">
                                ${avatardiv}
                                </div>
                                <div class="room-details">
                                    <span style="overflow: hidden;white-space: nowrap;text-overflow: ellipsis;" room-name-value="${roomie.id}" class="name-of-room" id="name-of-room">${new_string}</span>
                                    <p message-preview-value="${roomie.id}" class="preview">new message</p>
                                </div>
                                <span
                                     ellipsis-value="${roomie.id}" id="ellipsis-${roomie.id}" class="las la-ellipsis-v ellipsis">
                                    </span>
                                <div class="chat-dropdown">
                                            <div chat-dropdown-value="${roomie.id}" class="chat-dropdown-content">
                                                <a edit-button-value="${roomie.id}" class="edit-button" id="edit-${roomie.id}">Edit Name</a>
                                    <a delete-button-value="${roomie.id}" class="delete-button" id="delete-${roomie.id}">Delete Room</a>
                                            </div>
                                </div>
                            </div>

                        </li>`);

                        showDefaultAvatar();
                        editbuttonclicked(`ellipsis-${roomie.id}`);
                        menuclicked(`delete-${roomie.id}`, `edit-${roomie.id}`);
                        break;

                    case "print_title":

                        var new_title = data.room;
                        title = new_title.name;
                        console.log("title", title);
                        break;

                    case "edit":
                        var target_li = $("li[data-room-id=" + data.room + "]")[0];
                        var nameOfChat = target_li.getElementsByTagName("span")[0];

                        if (roomId == data.room) {
                            $(nameOfChat).html("");
                            $(nameOfChat).html(data.name);
                            $(".room-title").html("");
                            $(".room-title").html(data.name);
                        }
                        else {
                            $(nameOfChat).html("");
                            $(nameOfChat).html(data.name);
                        }
                        break;

                    default:
                        console.log("Unsupported message type!");
                        return;
                }

                $(".chat-messages").html();
                if (data.msg_type != "created")
                    msgdiv.append(ok_msg);

                msgdiv.scrollTop(msgdiv.prop("scrollHeight"));
            } else {
                console.log("Cannot handle message!");
            }
        };

        $("#add-members").click(function () {
            if (hideellipsis) {
                $("[chat-dropdown-value=" + chatDropdownId + "]").hide();
                hideellipsis = false;
            }
            else {

            }
            whitelist_2 = [];
            xisweird = 0;
            y = 0;
            z = 0;
            member = false;
            for (var j = 0; j < memberlist.length; j++) {
                var el = memberlist[j];
                for (var i = 0; i < nameofmembers.length; i++) {
                    if (el.name == nameofmembers[i]) {
                        member = true;
                    }
                }
                if (member == true) {
                    whitelist_2[z] = {

                        "value": el.value,
                        "name": el.name,
                        "avatar": "{% static 'app/images/PngItem_4212266.png' %}",
                        "email": el.email,
                        "disabled": true,
                    }
                    member = false;
                    z++;
                }
                else {
                    whitelist_2[z] = {
                        "value": el.value,
                        "name": el.name,
                        "avatar": "{% static 'app/images/PngItem_4212266.png' %}",
                        "email": el.email,
                        "disabled": false,
                    }

                    z++;
                }

            }
            socket.send(
                JSON.stringify({
                    command: "title",
                    room: roomId,
                })
            );

            $(".room-name").html("");
            $(".room-name").html(title);
            $("#members-page").show();

            fillarray2();

            /*
                        console.log("name", nameofmembers);
                        console.log("memberlist", memberlist);
                        console.log("whitelist", whitelist_2);
            */
        });



        // Says if we joined a room or not by if there's a div for it
        inRoom = function (roomId) {
            return $("#room-" + roomId).length > 0;
        };

        // Room join/leave

        /* -Show all saved messages when joining a room
                    -Make it if already in that room either do nothing or reload that room
                    -if not in that room leave current room, if in one, then join the
                    room that was clicked on
                    -If not in room when a message comes in give it an unread class*/



        function editbuttonclicked(buttonclicked) {
            $("#" + buttonclicked).click(function () {
                ellipsisClicked = true;
                hideellipsis = true;
                chatDropdownId = $(this).attr("ellipsis-value");
                $("[chat-dropdown-value=" + chatDropdownId + "]").toggle('show hide');
            });
        }


        function menuclicked(deletechat, edit) {
            $("#" + deletechat).click(function () {
                deleteroom = $(this).attr("delete-button-value");
                //modal show
                $(".confirmation-chat-modal").show();
                $("[chat-dropdown-value=" + chatDropdownId + "]").hide();

            });
            $("#" + edit).click(function () {
                editroom = $(this).attr("edit-button-value");
                //modal show
                $(".edit-chat-modal").show();



                $("[chat-dropdown-value=" + chatDropdownId + "]").hide();
                console.log("was clicked");
            });


        }
        function removeduserclicked(userclicked) {
            $("#" + userclicked).click(function () {
                removeduser = $(this).attr("data-id");
                //modal show
                $(".confirmation-modal").show();
            });
        }
        $("#confirm").click(function () {

            socket.send(
                JSON.stringify({
                    command: "remove",
                    room: roomId,
                    old_user: removeduser

                })
            );
            $(".confirmation-modal").hide();
        });
        $("#confirmation").click(function () {

            socket.send(
                JSON.stringify({
                    command: "delete",
                    room: deleteroom,
                })
            );
            $(".confirmation-chat-modal").hide();
        });
        $("#confirmation-of-name").click(function () {
            newChatName = document.querySelector('#chatName').value;
            socket.send(
                JSON.stringify({
                    command: "edit",
                    room: editroom,
                    newName: newChatName,
                })
            );
            $('input[name=new-chat-name]').val('');
            $(".edit-chat-modal").hide();
        });
        $("#exit-member-removal").click(function () {
            $(".confirmation-modal").hide();

        })
        $("#reverse").click(function () {
            $(".confirmation-chat-modal").hide();
        })
        $("#cancel-name").click(function () {
            $(".edit-chat-modal").hide();
        })
        $("#submit-users").on('click', function () {
            let arrayofnewusers = [];
            arrayofnewusers = JSON.parse($("#user-input").val());
            for (var i = 0; i < arrayofnewusers.length; i++) {
                var el = arrayofnewusers[i];
                arrayofusers[i] = el.name;
            }
            socket.send(
                JSON.stringify({
                    command: "add",
                    room: roomId,
                    newUsers: JSON.parse($("#user-input").val()),
                })
            );
            $("#members-page").hide();

        });
        function roomClick() {
            let b = 0;
            xisweird = 0;
            if (ellipsisClicked == false) {

                roomId = $(this).attr("data-room-id");
                groupName = $(this).attr("data-room-name");

                if (inRoom(roomId)) {
                    // Leave room

                    $(this).removeClass("joined");
                    socket.send(
                        JSON.stringify({
                            command: "leave",
                            room: roomId,
                        })
                    );
                    $(".chat-messages").empty();
                    //empty chat log
                } else {
                    // Join room
                    $(".list-of-members").empty();
                    $(".list-of-links").empty();
                    $(".list-of-files").empty();
                    $(".chat-messages").empty();

                    $(this).addClass("joined");
                    socket.send(
                        JSON.stringify({
                            command: "join",
                            room: roomId,
                        })
                    );

                    socket.send(
                        JSON.stringify({
                            command: "members",
                            room: roomId,
                        })
                    );

                    socket.send(
                        JSON.stringify({
                            command: "users",
                        })
                    );
                    $(this).addClass('active-room').siblings().removeClass('active-room');
                    for (var i = 0; i < avatararray.length; i++) {
                        av = avatararray[i];
                        if (av.group_id == roomId) {
                            $("#avatars").empty();
                            $("#avatars").append(av.group_avatar);
                            break;
                        }
                    }
                    showDefaultAvatar();
                    $("#title-img").show();
                    $(".user-header").show();
                    $(".user-header p").show();
                    $("#create-chat").show();
                    $("#tag-input").hide();
                    $("#users-list").hide();
                    $("#chat-name").hide();
                    $(".rightAccordion").show();
                    $(".rightPanel").show();



                    if (hideellipsis) {
                        $("[chat-dropdown-value=" + chatDropdownId + "]").hide();
                        hideellipsis = false;
                    }
                    else {

                    }
                    console.log(memberlist);
                }
            }
            else {
                ellipsisClicked = false;
            }
        }
        $(document).on('click', '.room-link', roomClick)

        // Creating Rooms

        $("#create-chat").click(function () {
            if (roomId) {
                if (inRoom(roomId)) {
                    // Leave room

                    $(this).removeClass("joined");
                    socket.send(
                        JSON.stringify({
                            command: "leave",
                            room: roomId,
                        })
                    );
                }
            }
            if (hideellipsis) {
                $("[chat-dropdown-value=" + chatDropdownId + "]").hide();
                hideellipsis = false;
            }
            else {

            }

            $("#title-img").hide();
            $("#upload-photos-button").show();
            $(".title-wrap").hide();
            $("#create-chat").hide();
            $("#tag-input").show();
            $("#users-list").show();
            $("#chat-name").show();
            $(".chat-messages").empty();
            $("#typed_msg").show();
            $(".msg_send_btn").show();
            $(".rightAccordion").hide();
            $(".rightPanel").hide();
            getallusers();
            createroom = true;
        });









        // Helpful debugging
        socket.onopen = function () {
            console.log("Connected to chat socket");
            socketopen++;
            if (socketopen == 1) {
                socket.send(
                    JSON.stringify({
                        "command": "rooms",
                    })
                );
            }
        };
        socket.onclose = function () {
            console.log("Disconnected from chat socket");
        };

        function fillarray2() {

            var input = document.querySelector('input[name=tags-manual-suggestions]');
            // init Tagify script on the above inputs
            input.addEventListener('change', onChange)

            function onChange(e) {
                if (input.value != 0) {
                    document.getElementById('submit-users').disabled = false;
                } else {
                    document.getElementById('submit-users').disabled = true;
                }
            }

            tagify = new Tagify(input, {
                tagTextProp: 'name', // very important since a custom template is used with this property as text
                templates: {
                    tag: function (tagData) {
                        try {
                            return `
                                <tag title="${tagData.email}"
                                    contenteditable='false'
                                    spellcheck='false'
                                    tabIndex="-1"
                                    class="tagify__tag ${tagData.class ? tagData.class : ""}"
                                    ${this.getAttributes(tagData)}>
                                <x title='' class='tagify__tag__removeBtn' role='button' aria-label='remove tag'></x>
                                <div>
                                    <div class='tagify__tag__avatar-wrap'>
                                        <img onerror="this.style.visibility='hidden'" src="${tagData.avatar}">
                                    </div>
                                    <span class='tagify__tag-text'>${tagData.name}</span>
                                </div>
                                </tag>`
                        }
                        catch (err) { }
                    },

                    dropdownItem: function (tagData) {
                        try {
                            if (tagData.disabled) {
                                return `
                               <div ${this.getAttributes(tagData)}
                                   style="display: none;"
                                   class='tagify__dropdown__item ${tagData.class ? tagData.class : ""}'
                                   tabindex="0"
                                   role="option">
                                   ${tagData.avatar ? `
                                   <div class='tagify__dropdown__item__avatar-wrap'>
                                       <img class='tagify__dropdown__item__avatar-wrap' onerror="this.style.visibility='hidden'" src="${tagData.avatar}">
                                   </div>` : ''
                                    }
                                   <strong>${tagData.name}</strong>
                                   <span>${tagData.email}</span>
                               </div>
                           `
                            }
                            else {
                                return `
                               <div ${this.getAttributes(tagData)}
                                   class='tagify__dropdown__item ${tagData.class ? tagData.class : ""}'
                                   tabindex="0"
                                   role="option">
                                   ${tagData.avatar ? `
                                   <div class='tagify__dropdown__item__avatar-wrap'>
                                       <img class='tagify__dropdown__item__avatar-wrap' onerror="this.style.visibility='hidden'" src="${tagData.avatar}">
                                   </div>` : ''
                                    }
                                   <strong>${tagData.name}</strong>
                                   <span>${tagData.email}</span>
                               </div>
                           `
                            }
                        }
                        catch (err) { }
                    }

                },

                dropdown: {
                    position: "manual",
                    maxItems: Infinity,
                    enabled: 0,
                    searchKeys: ['id', 'email'],  // very important to set by which keys to search for suggesttions when typing
                    classname: "customSuggestionsList"
                },
                enforceWhitelist: true,
                whitelist: []
            })

            //var whitelist_1 = [{ "value": 2, "name": "bannas", "avatar": "{% static 'app/images/PngItem_4212266.png' %}", "email": "oh" }];

            tagify.settings.whitelist = whitelist_2;


            tagify.on("dropdown:show", onSuggestionsListUpdate)
                .on("dropdown:hide", onSuggestionsListHide)
                .on('dropdown:scroll', onDropdownScroll)

            renderSuggestionsList()

            // ES2015 argument destructuring
            function onSuggestionsListUpdate({ detail: suggestionsElm }) {
                console.log(suggestionsElm)
            }

            function onSuggestionsListHide() {
                console.log("hide dropdown")
            }

            function onDropdownScroll(e) {
                console.log(e.detail)
            }

            // https://developer.mozilla.org/en-US/docs/Web/API/Element/insertAdjacentElement
            function renderSuggestionsList() {
                tagify.dropdown.show.call(tagify) // load the list
                tagify.DOM.scope.parentNode.appendChild(tagify.DOM.dropdown)
            }

            $("#canc").on('click', function () {
                document.getElementById('members-page').style.display = 'none'
            });

            $("#canc").on('click', tagify.removeAllTags.bind(tagify));


            $("#submit-users").on('click', tagify.removeAllTags.bind(tagify));




        }


        function getallusers() {
            var inputElm = document.querySelector('input[name=users-list-tags]');

            function tagTemplate(tagData) {
                return `
                    <tag title="${tagData.email}"
                            contenteditable='false'
                            spellcheck='false'
                            tabIndex="-1"
                            class="tagify__tag ${tagData.class ? tagData.class : ""}"
                            ${this.getAttributes(tagData)}>
                        <x title='' class='tagify__tag__removeBtn' role='button' aria-label='remove tag'></x>
                        <div>
                            <div class='tagify__tag__avatar-wrap'>
                                <img onerror="this.style.visibility='hidden'" src="${tagData.avatar}">
                            </div>
                            <span class='tagify__tag-text'>${tagData.name}</span>
                        </div>
                    </tag>
                    `
            }

            function suggestionItemTemplate(tagData) {
                return `
                <div ${this.getAttributes(tagData)}
                    class='tagify__dropdown__item ${tagData.class ? tagData.class : ""}'
                    tabindex="0"
                    role="option">
                    ${tagData.avatar ? `
                    <div class='tagify__dropdown__item__avatar-wrap'>
                        <img onerror="this.style.visibility='hidden'" src="${tagData.avatar}">
                    </div>` : ''
                    }
                    <strong>${tagData.name}</strong>
                    <span>${tagData.email}</span>
                </div>
                `
            }


            // initialize Tagify on the above input node reference
            var tagify2 = new Tagify(inputElm, {
                tagTextProp: 'name', // very important since a custom template is used with this property as text
                enforceWhitelist: true,
                skipInvalid: true, // do not remporarily add invalid tags

                dropdown: {
                    closeOnSelect: false,
                    enabled: 0,
                    classname: 'users-list',
                    searchKeys: ['name', 'email']  // very important to set by which keys to search for suggesttions when typing
                },
                templates: {
                    tag: tagTemplate,
                    dropdownItem: suggestionItemTemplate
                },

                whitelist: [
                    {% for user in users %}
            {
                    "value": "{{ user.pk }}",
                    "name": "{{user.username}}",
                    "avatar": "{% static 'app/images/PngItem_4212266.png' %}",
                    "email": "{{user.email}}"
                },
                {% endfor %}    
            ]


    })

    /*tagify2.on('dropdown:show dropdown:updated', onDropdownShow)


    function onDropdownShow(e) {
        var dropdownContentElm = e.detail.tagify2.DOM.dropdown.content;

    }*/
    $(".sending-form").on("submit", tagify2.removeAllTags.bind(tagify2));



}
    })
</script>



</html>
<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    {% load static %}
    {% load project_templates %}
    <room-details charset="utf-8" />
    <room-details name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css" />
    <link rel="stylesheet" href="{% static 'app/content/tagify.css' %}" />
    <link rel="stylesheet" href="{% static 'app/content/tags.css' %}" />
    <link rel="stylesheet" href="{% static 'app/content/chatPage.css' %}" />
    <link rel="stylesheet"
        href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" type="text/css"
        rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'app/content/style.css' %}" />

    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="{% static 'app/scripts/jquery.js' %}"></script>

    <script src="{% static 'app/scripts/jquery.ui.widget.js' %}"></script>
    <script src="{% static 'app/scripts/jquery.iframe-transport.js' %}"></script>
    <script src="{% static 'app/scripts/jquery.fileupload.js' %}"></script>

    <script src="{% static 'app/scripts/tag.js' %}"></script>
    <script src="{% static 'app/scripts/jQuery.tagify.min.js' %}"></script>
    <script>
        // if IE, add IE tagify's polyfills
        !(function (d) {
            if (!d.currentScript) {
                var s = d.createElement("script");
                s.src = "{% static 'app/scripts/tagify.polyfills.min.js' %}";
                d.head.appendChild(s);
            }
        })(document);
    </script>
    <style>
        @media only screen and (max-device-width: 1500px) {

            /* STYLES GO HERE */
            body {
                margin: 40px 10px;
                padding: 0;
                font-family: Helvetica;
                font-size: 14px;
                overflow: auto;
            }
        }

        body {
            margin: 40px 10px;
            padding: 0;
            font-family: Helvetica;
            font-size: 14px;
            overflow: hidden;
        }

        .customSuggestionsList>div {
            min-height: 300px;
            max-height: 300px;
            border: 2px solid lightblue;
            overflow: auto;
            margin: 5%;
            border-radius: 5px;
            box-shadow: 0 4px 8px 0 rgb(0 0 0 / 20%), 0 6px 20px 0 rgb(0 0 0 / 19%);
        }

        .profile-link .profile-pic-wrapper.profile-pic {
            margin-top: 10px;
            justify-content: center !important;
            align-items: center !important;
            white-space: nowrap !important;
            /* padding-bottom: 91px; */
            vertical-align: middle !important;
            /* padding-right: 32px;*/
        }

        .profile-link .online_icon {
            position: relative;
            display: inline-block;
            height: 10px;
            width: 10px;
            background-color: green;
            border-radius: 50%;
            bottom: 8px;
            right: -18px;
            border: 1.5px solid white;
        }

        .tagify__dropdown__item__avatar-wrap .online_icon {
            position: absolute;
            height: 10px;
            width: 10px;
            background-color: green;
            border-radius: 50%;
            bottom: 37px;
            left: 37px;
            border: 1.5px solid white;
            z-index: 1000;
        }

        .rooms-containter::-webkit-scrollbar {
            width: 8px;
            background: #2c3e50;
        }

        .rooms-containter::-webkit-scrollbar-thumb {
            background-color: #243140;
        }

        .rooms-containter ul li.room-link .wrap {
            width: 88%;
            margin: 0 auto;
            position: relative;
        }

        .room-details {
            display: flow-root;
            margin-left: 55px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .rooms-containter ul li.room-link .wrap span {
            position: absolute;
            left: 0;
            margin: -2px 0 0 -2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid #2c3e50;
            background: #95a5a6;

        }

        .room-details {

            overflow: hidden;
            margin-right: 30px;

        }

        .preview {

            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            -moz-transition: 1s all ease;
            -o-transition: 1s all ease;
            -webkit-transition: 1s all ease;
            transition: 1s all ease;
        }

        /*.rooms-containter ul li.room-link .wrap .room-details .preview span {
            position: initial;
            border-radius: initial;
            background: none;
            border: none;
            padding: 0 2px 0 0;
            margin: 0 0 0 1px;
            opacity: .5;
        }*/

        .wrap img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: inline-flex;
            flex-direction: row;
        }

        .unread {
            background-color: #FFFFE0 !important;
        }

        #avatars img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: inline-flex;
            flex-direction: row;
        }

        .avatars {
            position: relative;
            display: inline-flex;
            /* width: 40px; */
            float: left;
            /* margin-left: 0px; */
            /* margin-right: auto; */
            justify-content: center;
            margin-top: 10px;
            margin-bottom: 10pc;
        }

        .user-header #title-img {
            width: 50px;
            border-radius: 50%;
            margin-top: 1%;
            padding: 2px;
            height: auto;
            float: left;
            cursor: pointer;
            -moz-transition: 0.3s border ease;
            -o-transition: 0.3s border ease;
            -webkit-transition: 0.3s border ease;
            transition: 0.3s border ease;
            display: none;
        }

        .room-link {
            position: relative;

            font-size: 0.9em;
            cursor: pointer;
            height: 72px;
            max-height: 72px;
            min-height: 72px;
            text-overflow: ellipsis;
        }

        .name-of-room {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .ellipsis {
            position: relative;
            float: right;
            bottom: 50px;
            font-size: 25px;
            cursor: pointer;
            display: block;

        }

        .rightPanel {
            height: 250px;
            overflow-y: auto;
        }

        .remove-button {
            border-radius: 20%;
            font-size: 25px;
            position: relative;
            cursor: pointer;
            float: right;
            right: 2.5px;
            bottom: -1px;
        }

        .remove-button:hover {
            background-color: lightblue;
            color: blue;
        }


        /*.ellipsis:hover,
        .ellipsis:focus {
            background-color: #2980B9;
        }*/

        .chat-dropdown-content {

            /*display: none;
            position: relative;
            background-color: WHITE;
            width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 5;
            left: 160px;
            overflow: visible;*/

            display: none;
            background-color: WHITE;

            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 2202;
            position: fixed;

        }

        .chat-dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .chat-dropdown {
            position: relative;
            display: inline;
            bottom: 15px;
            z-index: 5;
        }

        .chat-dropdown-content a:hover {
            background-color: #ddd;
        }

        .Disconnected-modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 20000;
            /* Sit on top */
            left: 51px;
            top: 60px;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
            padding-top: 60px;
            overflow: hidden;
        }

        .confirmation-modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 2;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
            padding-top: 60px;
            overflow: hidden;
        }

        /* Modal Content/Box */
        #confirmation-page {
            background-color: #fefefe;
            margin: 5% auto 15% auto;
            /* 5% from the top, 15% from the bottom and centered */
            border: 1px solid #000;
            width: 30%;
            height: 30%;
            z-index: 3;
            border-radius: 5px;
            margin-right: 33%;
            /* Could be more or less, depending on screen size */
            box-shadow: 0 4px 8px 0 rgb(0 0 0 / 20%), 0 6px 20px 0 rgb(0 0 0 / 19%);
            overflow: hidden;
        }

        .edit-chat-modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 2;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
            padding-top: 60px;
            overflow: hidden;
        }

        /* Modal Content/Box */
        #change-name-page {
            background-color: #fefefe;
            margin: 5% auto 15% auto;
            /* 5% from the top, 15% from the bottom and centered */
            border: 1px solid #000;
            width: 40%;
            height: 45%;
            z-index: 3;
            border-radius: 5px;
            margin-right: 27%;
            /* Could be more or less, depending on screen size */
            box-shadow: 0 4px 8px 0 rgb(0 0 0 / 20%), 0 6px 20px 0 rgb(0 0 0 / 19%);
            overflow: hidden;
        }

        #confirmation-removal-page {
            background-color: #fefefe;
            margin: 5% auto 15% auto;
            /* 5% from the top, 15% from the bottom and centered */
            border: 1px solid #000;
            width: 30%;
            height: 30%;
            z-index: 3;
            border-radius: 5px;
            margin-right: 33%;
            /* Could be more or less, depending on screen size */
            box-shadow: 0 4px 8px 0 rgb(0 0 0 / 20%), 0 6px 20px 0 rgb(0 0 0 / 19%);
            overflow: hidden;
        }

        .confirmation-chat-modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 2;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
            padding-top: 60px;
            overflow: hidden;
        }

        #add-members {
            position: absolute;
            /*left: 630px;*/
            left: 93%;
            font-size: xx-large;
            bottom: 13px !important;
            display: none;
        }

        a {
            color: #21B5B7
        }

        .incoming-msg-img {
            float: left;
            width: 6%;
        }

        .outgoing-msg-img {
            float: right;
            width: 2%;
            padding-left: 5px;
        }

        .chat-wrapper {
            display: inline;
            /* clear: both; */
            width: -webkit-fill-available;
            font-size: 0.9em;
            position: relative;
        }

        .file_image {
            display: inline;
        }

        #doc {
            position: relative;
            height: 5%;
            width: 5%;
        }

        #pic {
            position: relative;
            height: 5%;
            width: 5%;
        }

        #vid {
            position: relative;
            height: 5%;
            width: 5%;
        }

        #etc {
            position: relative;
            height: 5%;
            width: 5%;
        }

        #msg_doc {
            position: relative;
            height: 32px;
            width: 32px;
            margin: 7px;
        }

        #msg_img {
            position: relative;
            height: 32px;
            width: 32px;
            margin: 7px;
        }

        #msg_vid {
            position: relative;
            height: 32px;
            width: 32px;
            margin: 7px;
        }

        #msg_etc {
            position: relative;
            height: 32px;
            width: 32px;
            margin: 7px;
        }

        .msgimg {
            display: flex;
            float: left;
            position: relative;
            justify-content: center;
            vertical-align: middle;
            margin-right: 5px;
            align-items: center;
            width: 100%;
        }

        .msgimgname {
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            justify-content: center;
            vertical-align: middle;
            align-items: center;
            display: inline;

        }

        .msgimginfo {
            display: inline;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            justify-content: center;
            vertical-align: middle;
            align-items: center;
        }

        .time_date {
            color: #747474;
            display: inline-flex;
            font-size: 12px;
            position: absolute;
            bottom: 0;
        }

        .oldermessage {
            margin-right: -33px;
        }

        .newermessage {
            margin-right: -54px;
        }

        .oldermessage2 {
            margin-left: -33px;
        }

        .newermessage2 {
            margin-left: -54px;
        }

        .topdown {
            bottom: 100%;
        }

        .la,
        .lab,
        .lad,
        .lal,
        .lar,
        .las {
            -moz-osx-font-smoothing: grayscale;
            -webkit-font-smoothing: antialiased;
            display: inline-block;
            font-style: normal;
            font-variant: normal;
            text-rendering: auto;
            /* line-height: 1; */
        }

        .unread-break-line {
            display: none;
            position: relative;
            width: 100%;
            color: red;
            border-bottom: 1px solid red;
        }

        .unread-break-line span {
            position: relative;
            margin-left: 50%;
        }

        .unread-break-line span::after {
            width: 100%;
            border-bottom: 1px solid red;
        }

        .unread-break-line hr {
            position: relative;
            border-color: red;
            width: 100%;
        }

        .main-content {
            margin-left: 41px;
            margin-right: -10px;
            background: #ebf2f2;
        }

        .notice-message {
            margin-bottom: 20px;
            margin-top: 5px;
            position: relative;
            color: grey;
            word-wrap: break-word;
            width: 40%;
            height: auto;
            justify-content: center;
            text-align: center;
            margin-left: 31%;
        }
    </style>
</head>

<!-- Make it autocomplete or somehting like that so not all users
show in the dropdown. Maybe an onChange functionality. Make it so dropdown
is empty when first clicked -->

<!--

-->

<body>
    <div class="sidebar">


        <div class="sidebar-menu">
            <ul>
                <li>
                    <a href="{% url 'dashboard' %}">
                        <span id="fist-element" class="las la-home"></span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'resourcedirectory' %}">
                        <span class="las la-book"></span>
                    </a>
                </li>
                <li>
                    <a class="active" href="{% url 'multichat' %}">
                        <span class="las la-comment-alt"></span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'clientlist' %}">
                        <span class="las la-user-friends"></span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'userinfo' %}">
                        <span class="las la-plus-circle"></span>
                    </a>
                </li>
            </ul>
        </div>
    </div>



    <header class="dash-header">

        <div class="sidebar-header">
            <span id="sidebar-toggle" class="las la-bars"></span>
        </div>
        <div id="leftside">
            <div class="search-wrapper">
                <span class="las la-search"></span>
                <input type="search" placeholder="Search here" />
            </div>
            <div class="vl"></div>
            <div class="dropdown">
                <div class="user-wrapper">
                    <div class="user-wrapper">
                        <a href="{% url 'profile' %}">
                            <div class="profile-pic-wrapper" data-username="{{user.username}}"
                                data-bgcolor="{{user.bgColor}}">
                                {% if user.avatar %}
                                <img class="profile-pic" src="{{user.avatar.url}}">
                                {% endif %}
                            </div>
                        </a>
                        <i id="caret-icon" style=font-size:25px;color:white;float:right; class="las la-angle-down"></i>
                        <div class="dropdown-content">
                            <div id="usermenu">
                                {% if user.id in userlist %}
                                {% for back in background %}
                                {% if back.user_id == user.id %}
                                <h3>{{ back.firstname }} {{ back.lastname }}</h3>
                                {% endif %}
                                {% endfor %}
                                {% else %}
                                <h3>{{ user.username }}</h3>
                                {% endif %}
                                {% if request.user|has_group:"caseworker" %}
                                <h4>Caseworker</h4>
                                {% elif request.user|has_group:"client" %}
                                <h4>Client</h4>
                                {% else %}
                                <h4>Not implemented</h4>
                                {% endif %}
                            </div>
                            <a href="{% url 'logout' %}">Log out</a>
                        </div>
                    </div>
                </div>
            </div>
    </header>

    <div class="main-content">
        <div class="chat-container">
            <div class="left-panel">
                <div class="left-panel-header">

                    <div class="search-container">
                        <input style="outline: none;" id="myInput" type="text" placeholder="Search.." name="search"
                            onkeyup="SearchFunction()" autocomplete="off" />
                    </div>
                    <p
                        style="color:#015D67; font-weight: bold; font-size: large;margin-left: 5%; margin-top: 20px; margin-bottom: 0.5rem;">
                        Current Client
                        Chats


                    </p>
                    <hr style="color:black; margin-top:0;margin-bottom: 0;overflow: hidden;     width: 90%;
                        margin-left: 5%; border-top:2px solid black">
                </div>


                <div class="rooms-container">

                    <ul id="rooms" class="rooms" style="height: 100%;">
                    </ul>
                </div>
                <div class="creating-chat-section" style="z-index: 1;">
                    <button style="margin-top: 3.3%;" id="create-chat"><strong>Open New Chat </strong><i style="  float: right;
                        font-size: 30px;
                        color: #015D67;
                        font-weight: bold;
                        margin: 0;
                        position: absolute;
                        top: 50%;
                        left: 90%;
                        -ms-transform: translate(-90%, -50%);
                        transform: translate(-90%, -50%);" class="las la-plus-circle"></i></button><br />
                </div>
            </div>
            <div class="middle-panel">
                <div class="user-header">
                    <section id="users-list"
                        style="display: none; position: relative; background-color: #fff; bottom: 3px;">

                        <input id="tag-input" style="display: none; position: relative; background-color: #fff;"
                            name="users-list-tags" />

                    </section>
                    <div class="title-wrap" style="display: inline;margin-top:10px">
                        <b>
                            <div class="avatars" id="avatars" style="margin-left: 10px;"></div>
                            <p class="room-title"
                                style=" width: 50%; color:#015D67; font-weight: bold; font-size: large; overflow:hidden; white-space: nowrap;text-overflow:ellipsis;margin-left: 65px;">
                            </p>
                        </b>
                        <i id="add-members" class="las la-plus-circle" style="color:#015D67;cursor: pointer;"></i>
                    </div>
                </div>

                <div class="chat-log" style="width: 100%;">
                </div>
                <div class="input-section">
                    <input id="fileupload" type="file" name="file" multiple style="display: none"
                        data-url="{% url 'upload' %}" data-form-data='{"csrfmiddlewaretoken": "{{ csrf_token }}"}' />
                    <!--<form class="creating-form">
                        <input type="text" style="display: none;margin-top: 4%;" id="created_typed_msg"
                            placeholder="Type a message" name="create-chat-message" required />
                        <i id="created-upload-photos-button" class="las la-paperclip"
                            style="display:none;cursor:pointer;font-size:25px;margin-top: 5%;"></i>
                        <button class="created_msg_send_btn" style="display: none;" type="submit"><i
                                style="color: white;font-size: 22px;" class="las la-paper-plane"
                                aria-hidden="true"></i></button>
                    </form>
                -->
                    <form class="sending-form">
                        <input type="text" style="display: none;margin-top: 4%; outline: none;" id="typed_msg"
                            placeholder="Type a message" name="chat-message" autocomplete="off" required />
                        <i id="upload-photos-button" class="las la-paperclip"
                            style="display:none;cursor:pointer;font-size:25px;margin-top: 5%;"></i>
                        <button class="msg_send_btn" style="display: none;" type="submit"><i
                                style="color: white;font-size: 22px;margin-top:4px;margin-left:2px;"
                                class="las la-paper-plane" aria-hidden="true"></i></button>
                    </form>

                </div>
            </div>
            <div class="right-panel">
                <button class="rightAccordion" style="display: none;">Members</button>
                <div class="rightPanel">

                    <ul class="right-btn-group">
                        <li class="list-of-members">

                        </li>
                    </ul>
                </div>
                <button class="rightAccordion">Files</button>
                <div class="rightPanel">
                    <ul class="right-btn-group">
                        <li class="list-of-files">

                        </li>
                    </ul>
                </div>

                <button class="rightAccordion">Links</button>
                <div class="rightPanel">
                    <ul class="right-btn-group">
                        <li class="list-of-links">

                        </li>
                    </ul>
                </div>
                <script src="{% static 'app/scripts/rightChat.js' %}"></script>
            </div>
        </div>
    </div>
</body>
<input id="myself" type="hidden" value="{{request.user.username}}" />
<br />

<div id="members-page">

    <div id="members-page-content">
        <header>
            <div><span style="padding-left: 5%;font-size:x-large;">Add Members</span>
                <i class="las la-window-close" style="right:0; height: 10%; float:right; position: relative;"
                    onclick="document.getElementById('members-page').style.display='none'" id="close"
                    title="Close Modal"></i>
            </div>
            <div><span class="room-name" style="padding-left: 5%;font-size:large;"></span></div>

        </header>

        <div>
            <section id="section-manual-suggestions">
                <input style="margin-left: 5%;" name='tags-manual-suggestions' placeholder='Search Users'
                    id="user-input">
            </section>

            <div>
                <p style="margin-left: 5%;">
                    <strong>Privacy</strong> <br>
                    - External users cannot be added <br>
                    - New members will see previous messages and files
                </p>
            </div>
        </div>
        <footer style="margin-top: 1%; float: right; margin-right: 5%">
            <span>
                <button id="submit-users" type="button" class="btn btn-primary" disabled>Add Users</button>
                <button type="button" class="btn btn-outline-secondary" name='cancel' id="canc">Cancel</button>
            </span>
        </footer>
    </div>
</div>
<div class="confirmation-modal">
    <div id="confirmation-page">
        <div>
            <p style="margin-left: 5%; padding-top: 5%">
                <strong>Remove User</strong> <br>
            <p style="margin-left: 5%; padding-top: 2%">
                Are you sure you wish to remove this user? <br>
                They will no longer be a member of this chat. <br>
            </p>
            </p>
        </div>
        <span style="margin-top: 5%; float: right; margin-right: 5%">
            <button id="confirm" type="button" class="btn btn-primary">Confirm</button>
            <button type="button" class="btn btn-outline-secondary" id="exit-member-removal">Cancel</button>
        </span>
    </div>
</div>

<div class="confirmation-chat-modal">
    <div id="confirmation-removal-page">
        <div>
            <p style="margin-left: 5%; padding-top: 5%">
                <strong>Remove Chat</strong> <br>
            <p style="margin-left: 5%; padding-top: 2%">
                Are you sure you wish to delete this chat? <br>
                You will no longer be a member of this chat <br>
                and you will no longer have access to past messages.
            </p>
            </p>
        </div>
        <span style="margin-top: 5%; float: right; margin-right: 5%">
            <button id="confirmation" type="button" class="btn btn-primary">Confirm</button>
            <button type="button" class="btn btn-outline-secondary" id="reverse">Cancel</button>
        </span>
    </div>
</div>
<div class="edit-chat-modal">
    <div id="change-name-page">
        <h3 style="margin-left: 5%;margin-top: 5%;">Edit Chat Name</h3>

        <p style="margin-left: 5%;">
            <input style="    padding: 6px;
            margin-top: 5%;
            font-size: 17px;
            border-style: solid;
            border-width: 1px;
            border-radius: 5px;
            border-color: #afafaf;
            width: 95%;
            position: relative;
            height: 60%;" type="text" placeholder="New Name..." name='new-chat-name' id="chatName"
                onkeyup="onChangeName()" onkeypress="return /[0-9a-zA-Z]/.test(event.key);" maxlength="100" />

        </p>
        <div>
            <p style="margin-left: 5%; padding-top: 5%;">
                <strong>Notice</strong> <br>
                - Can not name room the same as another <br>
                - Chat name can not be changed back
            </p>
        </div>

        <span style="margin-top: 5%; float: right; margin-right: 5%">
            <button id="confirmation-of-name" type="button" class="btn btn-primary" disabled>Confirm</button>
            <button type="button" class="btn btn-outline-secondary" id="cancel-name">Cancel</button>
        </span>
    </div>

</div>
<div class="Disconnected-modal">

</div>


<audio id="chatAudio">
    <source src="{% static 'app/audio/notification.mp3' %}" type="audio/mpeg">
</audio>
<script src="https://cdnjs.cloudflare.com/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.min.js"
    integrity="sha512-B4skI5FiLurS86aioJx9VfozI1wjqrn6aTdJH+YQUmCZum/ZibPBTX55k5d9XM6EsKePDInkLVrN7vPmJxc1qA=="
    crossorigin="anonymous"></script>
<script src="{% static 'app/scripts/default_avatar.js' %}"></script>


<script>

    $("#caret-icon").on('click', function () {
        $(this).toggleClass('la-angle-up la-angle-down');
        $(".dropdown-content").toggle('show hide');
    })

    $("#sidebar-toggle").on('click', function () {
        $(".sidebar").toggle('show hide');
    })
</script>
<script>
    let roomId = false;
    let nameofmembers = [];
    var whitelist_2 = [];
    var xisweird = 0;
    var y = 0;
    var z = 0;
    let member = false;
    var memberlist = [];
    let tagger = document.getElementById('user-input');
    let inRoom = false;
    let groupName = false;
    let allRooms = [];
    let createroom = false;
    let socketopen = null;
    let text_changed = false;
    let link = [];
    let typedmessage = null;
    let found = null;
    var prefix = 'https://';
    var prefix2 = 'http://'
    let ellipsisClicked = false;
    //let hideellipsis = false;
    let timeid = 0;
    let removeduser = null;
    let removedusername = null;
    var allnewusers = [];
    let emptyroom = false;
    var newChat = document.getElementById('chatName');
    let avatararray = [];
    let arrayofusers = [];
    let a = 0;
    let ext = null;
    let extension = null;
    let roomexists = null;
    let avatarsexist = false;
    let createconfirmation = 0;
    let joinedroom = false;
    let createroomid = false;
    let wasclicked = false;
    let notice = false;
    let unreadnotdisplayed = true;
    const noticeMessage = "User made change to chat."


    function onChangeName(event) {

        /* alphanumeric = /[0-9a-zA-Z]/;
         let isValid = alphanumeric.test(event.key);
 
         let inputLength = newChat.value.length;
         if (isValid) {
             inputLength += 1;
         }*/

        if (newChat.value.length > 0) {
            document.getElementById('confirmation-of-name').disabled = false;
        }
        else {
            document.getElementById('confirmation-of-name').disabled = true;
        }

        //return isValid;

    }

    function SearchFunction() {
        /*if (hideellipsis) {
            $("[chat-dropdown-value=" + chatDropdownId + "]").hide();
            hideellipsis = false;
        }*/

        search_input = $("#myInput")[0];
        var filter = search_input.value.toUpperCase();
        var ul = document.getElementById("rooms");
        var li = ul.getElementsByClassName("room-link");
        for (i = 0; i < li.length; i++) {
            var a = li[i].getElementsByTagName("span")[0];
            var txtValue = a.textContent || a.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                li[i].style.display = "";
            } else {
                li[i].style.display = "none";
            }
        }
    }
    /*function mySubmitFunction(e) {
        e.preventDefault();
        var userinput = document.querySelector('input[name=users-list-tags]');
        if (createroom == true) {
            if (userinput.value < 1) {
                return false;
            }
        }

        else {
            return true;
        }
    }*/

    window.onclick = function (event) {
        var modal = $(".chat-dropdown-content");
        var modal2 = $(".ellipsis");
        if (!modal.toArray().includes(event.target) && !modal2.toArray().includes(event.target)) {
            enableScroll();
            $(".chat-dropdown-content").hide();
        }

    }
    var keys = { 37: 1, 38: 1, 39: 1, 40: 1 };

    function preventDefault(e) {
        e.preventDefault();
    }

    function preventDefaultForScrollKeys(e) {
        if (keys[e.keyCode]) {
            preventDefault(e);
            return false;
        }
    }

    // modern Chrome requires { passive: false } when adding event
    var supportsPassive = false;
    try {
        window.addEventListener("test", null, Object.defineProperty({}, 'passive', {
            get: function () { supportsPassive = true; }
        }));
    } catch (e) { }

    var wheelOpt = supportsPassive ? { passive: false } : false;
    var wheelEvent = 'onwheel' in document.createElement('div') ? 'wheel' : 'mousewheel';

    // call this to Disable
    function disableScroll() {
        //var scrollrooms = $(".rooms");
        console.log("disable scroll");
        var element = document.getElementById('rooms');
        element.addEventListener('DOMMouseScroll', preventDefault, false); // older FF
        element.addEventListener(wheelEvent, preventDefault, wheelOpt); // modern desktop
        element.addEventListener('touchmove', preventDefault, wheelOpt); // mobile
        element.addEventListener('keydown', preventDefaultForScrollKeys, false);
    }

    // call this to Enable
    function enableScroll() {
        //var scrollrooms = $(".rooms");
        console.log("enable scroll");
        var element = document.getElementById('rooms');
        element.removeEventListener('DOMMouseScroll', preventDefault, false);
        element.removeEventListener(wheelEvent, preventDefault, wheelOpt);
        element.removeEventListener('touchmove', preventDefault, wheelOpt);
        element.removeEventListener('keydown', preventDefaultForScrollKeys, false);
    }
    /*function disableScroll() {
        // Get the current page scroll position
        var scrollrooms = $(".rooms");
        var scrollroomsoffset = scrollrooms.offset();
        scrollTop =
            scrollroomsoffset.pageYOffset || document.documentElement.scrollTop;
        scrollLeft =
            scrollroomsoffset.pageXOffset || document.documentElement.scrollLeft,

            // if any scroll is attempted,
            // set this to the previous value
            scrollrooms.on("scroll", function () {
                console.log("rooms onscroll")
                scrollrooms.scrollTop(scrollTop);
            });
    }*/

    /*function disableScroll() {
        // Get the current page scroll position
        var element = document.getElementById('rooms');
        scrollTop = element.pageYOffset || document.documentElement.scrollTop;
        scrollLeft = element.pageXOffset || document.documentElement.scrollLeft,

            // if any scroll is attempted, set this to the previous value
            element.onscroll = function () {
                element.scrollTo(scrollLeft, scrollTop);
            };
    }

    function enableScroll() {
        element.onscroll = function () { };
    }*/
    $(function () {

        // Correctly decide between ws:// and wss://
        var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        var ws_path = ws_scheme + "://" + window.location.host + "/chat/stream/";
        console.log("Connecting to " + ws_path);

        //var socket = new WebSocket(ws_path);
        var socket = new ReconnectingWebSocket(ws_path);
        var roomName = null;
        var title = null;



        $(".sending-form").on("submit", function () {
            typedmessage = document.querySelector('#typed_msg').value;
            if (createroom == false) {
                event.preventDefault();
                if (roomName) {
                    socket.send(
                        JSON.stringify({
                            "command": "send",
                            "room": roomName,
                            "from_user": $("#myself").val(),
                            "message": typedmessage,
                            "file": false,
                            "notice": false,
                        })
                    );
                    $(".unread-break-line").hide();
                    unreadnotdisplayed = true;
                    $('input[name=chat-message]').val('');

                }
            }
            else if (createroom == true && createconfirmation == 1) {
                event.preventDefault();
                socket.send(
                    JSON.stringify({
                        "command": "create",
                        "message": typedmessage,
                        "newUsers": JSON.parse($("#tag-input").val()),
                        "created_by": $("#myself").val(),
                        "file": false,
                        "notice": false,
                    })
                );
                $("#tag-input").hide();
                $("#users-list").hide();
                $("#chat-name").hide();
                $("#tag-input").empty();
                $(".user-header").show();
                $(".user-header p").hide();
                $("#title-img").hide();
                $("#create-chat").show();
                $("#upload-photos-button").hide();
                $(".msg_send_btn").hide();
                $(".rightAccordion").show();
                $("#typed_msg").empty();
                $(".rightAccordion").hide();
                $(".rightPanel").hide();
                $('input[name=chat-message]').val('');
                $("#typed_msg").hide();
                createroom = false;
            }
            else if (createroom == true && createconfirmation == 0) {
                //show error
                event.preventDefault();
                alert("Users Need to be selected.");
            }
        });

        $("#upload-photos-button").click(function () {
            $("#fileupload").click();
        });

        /* 2. INITIALIZE THE FILE UPLOAD COMPONENT */
        $("#fileupload").fileupload({
            dataType: 'json',
            done: function (e, data2) {  /* 3. PROCESS THE RESPONSE FROM THE SERVER */
                if (data2.result.is_valid) {
                    /*send file to recipient and add a progress bar*/
                    const message = '<a size-id="' + data2.result.size + '" href="' + data2.result.url + '" target="_blank">' + data2.result.name + '</a>'
                    if (createroom == false) {
                        if (roomName) {
                            socket.send(
                                JSON.stringify({
                                    "command": "send",
                                    "room": roomName,
                                    "message": message,
                                    "from_user": $("#myself").val(),
                                    "file": true,
                                    "notice": false,
                                })
                            );
                            $(".unread-break-line").hide();
                            unreadnotdisplayed = true;
                        }
                    }
                    else if (createroom == true && createconfirmation == 1) {
                        socket.send(
                            JSON.stringify({
                                "command": "create",
                                "newUsers": JSON.parse($("#tag-input").val()),
                                "message": message,
                                "created_by": $("#myself").val(),
                                "file": true,
                                "notice": false,
                            })
                        );
                        $("#tag-input").hide();
                        $("#users-list").hide();
                        $("#chat-name").hide();
                        $("#tag-input").empty();
                        $(".user-header").show();
                        $(".user-header p").hide();
                        $("#title-img").hide();
                        $("#create-chat").show();
                        $("#upload-photos-button").hide();
                        $(".msg_send_btn").hide();
                        $(".rightAccordion").show();
                        $("#typed_msg").empty();
                        $(".rightAccordion").hide();
                        $(".rightPanel").hide();
                        $('input[name=chat-message]').val('');
                        $("#typed_msg").hide();
                        createroom = false;
                    }
                    else if (createroom == true && createconfirmation == 0) {
                        //show error modal
                        event.preventDefault();
                        alert("Users Need to be selected.");
                    }


                }
            }
        });

        // Handle incoming messages
        socket.onmessage = function (message) {
            var data = JSON.parse(message.data);
            console.log("data", data)
            // Handle errors
            if (data.error) {
                alert(data.error);
                return;
            }

            message = data.message


            // Handle joining
            if (data.join) {
                console.log("Joining room " + data.join);
                roomName = data.join;
                title = data.title;
                joinedroom = true;
                createroomid = roomId;
                //   console.log("myself value: " + $("#myself").val() + "data.from_user value: " + message.from_user)

                // Hook up send button to send a message




                //hook up sending files
                /* 1. OPEN THE FILE EXPLORER WINDOW */
                var obj = data.title;
                //var extra = ", ";

                var me = $("#myself").val();
                if (obj.match(me)) {
                    me = $("#myself").val() + ", ";
                    me2 = ", " + $("#myself").val();
                    var comma = obj.replace(/-/g, ', ');
                    var new_string = comma.replace(me, "");
                    new_string = new_string.replace(me2, "");
                    new_string = "me, " + new_string;
                    new_string = new_string.replace(/-deleted/g, "");
                    new_string = new_string.replace(/-removed/g, "");
                    new_string = new_string.replace(/-additional/g, "");
                    new_string = new_string.replace(/, deleted/g, "");
                    new_string = new_string.replace(/, additional/g, "");
                    new_string = new_string.replace(/, removed/g, "");
                }
                else {
                    var new_string = obj.replace(/-deleted/g, "");
                    new_string = new_string.replace(/-removed/g, "");
                    new_string = new_string.replace(/-additional/g, "");
                    new_string = new_string.replace(/, deleted/g, "");
                    new_string = new_string.replace(/, additional/g, "");
                    new_string = new_string.replace(/, removed/g, "");
                }

                $(".user-header p").html(new_string);

                // Handle leaving
            } else if (data.leave) {
                console.log("Leaving room " + data.leave);
                roomName = null;
                joinedroom = false;
                // Handle getting a message
            } else if (data.message || data.msg_type != 0) {
                var msgdiv = $(".chat-log");
                var ok_msg = "";



                // msg types are defined in chat/settings.py
                // Only for demo purposes is hardcoded, in production scenarios, consider call a service.
                const LEFT_ROOM = 5;
                switch (data.msg_type) {
                    case 0:
                        // Message

                        let text = (data.message.text) ? data.message.text : data.message;
                        let user = (data.message.from_user) ? data.message.from_user : data.username;
                        let useravatar = (data.message.avatar) ? data.message.avatar : data.avatar;
                        let defaultcolor = (data.message.default) ? data.message.default : data.default;
                        let avatarofchatlog = useravatar ? '<img class="profile-pic" src="' + useravatar + '">' : '<div class="profile-pic-wrapper" data-username="' + user + '" data-bgcolor="' + defaultcolor + '"></div>'
                        //if statement for where user.username is not equal to data.message.from_user
                        let time = (data.message.sent_at) ? data.message.sent_at : data.sent_at;
                        let iftime = (data.message.sent_at) ? data.message.sent_at : data.sent_at;
                        let notificationofmessage = (data.message.notification) ? data.message.notification : data.notification;
                        let unreadmessage = (data.message.unread !== undefined) ? data.message.unread : data.unread;
                        let is_file = (data.message.is_file !== undefined) ? data.message.is_file : data.is_file;
                        let notice = (data.message.notice !== undefined) ? data.message.notice : data.notice;
                        let received = (data.message.received !== undefined) ? data.message.received : data.received
                        const NewMessage = "New Message";
                        const cssClass = $("#myself").val() == user ? 'outgoing' : 'incoming';
                        var d = new Date();
                        var month = d.toLocaleString('default', { month: 'short' }); //months from 1-12
                        var day = d.getDate();
                        var date = "";
                        date = month + " " + day + ",";
                        if (time.match(date)) {
                            time = time.replace(date, "");
                        }
                        else {
                            /*var timeregex = new RegExp("^[0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$");
                            time = time.replace(timeregex, "");*/
                            time = time.substr(0, time.lastIndexOf(",") + 1);
                            time = time.replace(",", "");

                        }
                        if (notificationofmessage) {
                            if (!notice) {
                                $("[message-preview-value=" + data.room + "]").html("");
                                $("[message-preview-value=" + data.room + "]").html(text);
                            }
                            if (notice) {
                                $("[message-preview-value=" + data.room + "]").html("");
                                $("[message-preview-value=" + data.room + "]").html(noticeMessage);
                            }
                            if (user != $("#myself").val()) {
                                var musicnotification = document.getElementById("chatAudio");
                                musicnotification.play();
                            }
                        }
                        //extract the url from the message
                        let pattern = new RegExp("([a-zA-Z0-9]+://)?([a-zA-Z0-9_]+:[a-zA-Z0-9_]+@)?([a-zA-Z0-9.-]+\\.[A-Za-z]{2,4})(:[0-9]+)?(/[^><]*)?", "g")
                        if (!is_file && !notice) {

                            result = text.replace(pattern, function (url) {
                                ;
                                //should i replace text with url because I believe
                                //it is passing the found ones into url
                                if (url.substr(0, prefix.length) !== prefix || url.substr(0, prefix.length) !== prefix2) {
                                    s = prefix + url;
                                }
                                else {
                                    s = url;
                                }
                                $(".list-of-links").append(
                                    `<li>
                                    <i class="las la-link" style="display: inline;"><a href="${s}">${url}</a></i>
                                    </li>`
                                );
                                return '<a href="' + s + '">' + url + '</a>';

                            })


                            if (cssClass == 'outgoing') {
                                $(".chat-log").append(
                                    `<div class='chat-wrapper' style="float: right; margin-right: 25px;">` +
                                    `<div class='outgoing-msg-img'>` + avatarofchatlog + `</div>` +
                                    `<div class='${cssClass}' id='time-${timeid}'>` +
                                    result +
                                    `</div>` +
                                    `<span class='time_date'id='date-${timeid}' style="">` +
                                    time +
                                    `</span>` +
                                    `</div>`);

                                if (iftime.match(date)) {
                                    let idoftime = "time-" + timeid;
                                    var marginid = document.getElementById(idoftime);
                                    var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                    var intwidth = parseInt(msgwidth);
                                    intwidth = intwidth - 40;
                                    intwidth = intwidth.toString()
                                    var newwidth = intwidth + "px";
                                    document.getElementById('date-' + timeid).style.right = newwidth;
                                    timeid++;
                                }
                                else {
                                    let idoftime = "time-" + timeid;
                                    var marginid = document.getElementById(idoftime);
                                    var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                    var intwidth = parseInt(msgwidth);
                                    intwidth = intwidth - 20;
                                    intwidth = intwidth.toString()
                                    var newwidth = intwidth + "px";
                                    document.getElementById('date-' + timeid).style.right = newwidth;
                                    timeid++;
                                }
                            } else {
                                if (unreadmessage && unreadnotdisplayed) {
                                    $(".chat-log").append(
                                        `<div class='unread-break-line'>` +
                                        `<span style='text-align: center;'>` +
                                        NewMessage +
                                        `</span>` +
                                        `</div>`);
                                    $(".unread-break-line").show();
                                    unreadnotdisplayed = false;
                                }
                                if (received === true) {
                                    $(".unread-break-line").hide();
                                    unreadnotdisplayed = true;
                                }
                                $(".chat-log").append(
                                    `<div class='chat-wrapper' style="float: left; margin-left: 25px;">` +
                                    `<div class='incoming-msg-img'>` + avatarofchatlog + `</div>` +
                                    `<div class='${cssClass}' id='time-${timeid}'>` +
                                    result +
                                    `</div>` +
                                    `<span class='time_date' id='date-${timeid}'>` +
                                    time +
                                    `</span>` +
                                    `</div>`);
                                if (iftime.match(date)) {
                                    let idoftime = "time-" + timeid;
                                    var marginid = document.getElementById(idoftime);
                                    var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                    var intwidth = parseInt(msgwidth);
                                    intwidth = intwidth + 5;
                                    intwidth = intwidth.toString()
                                    var newwidth = intwidth + "px";
                                    document.getElementById('date-' + timeid).style.left = newwidth;
                                    timeid++;
                                }
                                else {
                                    let idoftime = "time-" + timeid;
                                    var marginid = document.getElementById(idoftime);
                                    var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                    var intwidth = parseInt(msgwidth);
                                    intwidth = intwidth + 5;
                                    intwidth = intwidth.toString()
                                    var newwidth = intwidth + "px";
                                    document.getElementById('date-' + timeid).style.left = newwidth;

                                    timeid++;
                                }
                            }
                        }
                        else if (notice && !is_file) {
                            $(".chat-log").append(
                                `<div class='notice-message'>` +
                                `<span>` +
                                text +
                                `</span>` +
                                `</div>`);
                        }
                        else if (is_file && !notice) {
                            ext = text.split(".");
                            extension = ext[ext.length - 1];
                            extension = extension.replace("</a>", "")
                            extension = extension.toLowerCase();
                            var fileinfo = extension.toUpperCase();
                            if (extension == 'pdf' || extension == 'doc' || extension == 'docx' || extension == 'txt' || extension == 'odt' || extension == 'ppt' || extension == 'pptx' || extension == 'html' || extension == 'rtf') {
                                fileinfo = fileinfo + " Document";
                                $(".list-of-files").append(
                                    `<li>
            		                <a> 
                                    <span class="file_image"><img id="doc" src="{% static 'app/images/documents.png' %}"></span>` +
                                    text +
                                    `</a>
        	                        </li>`)

                                if (cssClass == 'outgoing') {
                                    $(".chat-log").append(
                                        `<div class='chat-wrapper' style="float: right; margin-right: 25px;">` +
                                        `<div class='outgoing-msg-img'>` + avatarofchatlog + `</div>` +
                                        `<div class='${cssClass}' id='time-${timeid}'>` +
                                        `<div class='msgimg'>` +
                                        `<img id="msg_doc" src="{% static 'app/images/documents.png' %}">` +
                                        `<div class='msgimgname'>` +
                                        text +
                                        `<br>` +
                                        `<div class='msgimginfo'>` +
                                        fileinfo +
                                        `</div>` +
                                        `</div>` +
                                        `</div>` +
                                        `</div>` +
                                        `<span class='time_date'id='date-${timeid}' style="">` +
                                        time +
                                        `</span>` +
                                        `</div>`);
                                    if (iftime.match(date)) {
                                        let idoftime = "time-" + timeid;
                                        var marginid = document.getElementById(idoftime);
                                        var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                        var intwidth = parseInt(msgwidth);
                                        intwidth = intwidth - 40;
                                        intwidth = intwidth.toString()
                                        var newwidth = intwidth + "px";
                                        document.getElementById('date-' + timeid).style.right = newwidth;
                                        timeid++;
                                    }
                                    else {
                                        let idoftime = "time-" + timeid;
                                        var marginid = document.getElementById(idoftime);
                                        var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                        var intwidth = parseInt(msgwidth);
                                        intwidth = intwidth - 20;
                                        intwidth = intwidth.toString()
                                        var newwidth = intwidth + "px";
                                        document.getElementById('date-' + timeid).style.right = newwidth;
                                        timeid++;
                                    }
                                } else {
                                    if (unreadmessage && unreadnotdisplayed) {
                                        $(".chat-log").append(
                                            `<div class='unread-break-line'>` +
                                            `<span style='text-align: center;'>` +
                                            NewMessage +
                                            `</span>` +
                                            `</div>`);
                                        $(".unread-break-line").show();
                                        unreadnotdisplayed = false;
                                    }
                                    $(".chat-log").append(
                                        `<div class='chat-wrapper' style="float: left; margin-left: 25px;">` +
                                        `<div class='incoming-msg-img'>` + avatarofchatlog + `</div>` +
                                        `<div class='${cssClass}' id='time-${timeid}'>` +
                                        `<div class='msgimg'>` +
                                        `<img id="msg_doc" src="{% static 'app/images/documents.png' %}">` +
                                        `<div class='msgimgname'>` +
                                        text +
                                        `<br>` +
                                        `<div class='msgimginfo'>` +
                                        fileinfo +
                                        `</div>` +
                                        `</div>` +
                                        `</div>` +
                                        `</div>` +
                                        `<span class='time_date' id='date-${timeid}'>` +
                                        time +
                                        `</span>` +
                                        `</div>`);
                                    if (iftime.match(date)) {
                                        let idoftime = "time-" + timeid;
                                        var marginid = document.getElementById(idoftime);
                                        var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                        var intwidth = parseInt(msgwidth);
                                        intwidth = intwidth - 40;
                                        intwidth = intwidth.toString()
                                        var newwidth = intwidth + "px";
                                        document.getElementById('date-' + timeid).style.left = newwidth;
                                        timeid++;
                                    }
                                    else {
                                        let idoftime = "time-" + timeid;
                                        var marginid = document.getElementById(idoftime);
                                        var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                        var intwidth = parseInt(msgwidth);
                                        intwidth = intwidth - 20;
                                        intwidth = intwidth.toString()
                                        var newwidth = intwidth + "px";
                                        document.getElementById('date-' + timeid).style.left = newwidth;

                                        timeid++;
                                    }
                                }

                            }
                            else if (extension == 'jpg' || extension == 'png' || extension == 'gif' || extension == 'jpeg') {
                                fileinfo = fileinfo + " Image";
                                $(".list-of-files").append(
                                    `<li>
            		                <a> 
                                    <span class="file_image"><img id="pic" src="{% static 'app/images/images.png' %}"></span>` +
                                    text +
                                    `</a>
        	                        </li>`)
                                if (cssClass == 'outgoing') {
                                    $(".chat-log").append(
                                        `<div class='chat-wrapper' style="float: right; margin-right: 25px;">` +
                                        `<div class='outgoing-msg-img'>` + avatarofchatlog + `</div>` +
                                        `<div class='${cssClass}' id='time-${timeid}'>` +
                                        `<div class='msgimg'>` +
                                        `<img id="msg_img" src="{% static 'app/images/images.png' %}">` +
                                        `<div class='msgimgname'>` +
                                        text +
                                        `<br>` +
                                        `<div class='msgimginfo'>` +
                                        fileinfo +
                                        `</div>` +
                                        `</div>` +
                                        `</div>` +
                                        `</div>` +
                                        `<span class='time_date'id='date-${timeid}' style="">` +
                                        time +
                                        `</span>` +
                                        `</div>`);
                                    if (iftime.match(date)) {
                                        let idoftime = "time-" + timeid;
                                        var marginid = document.getElementById(idoftime);
                                        var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                        var intwidth = parseInt(msgwidth);
                                        intwidth = intwidth - 40;
                                        intwidth = intwidth.toString()
                                        var newwidth = intwidth + "px";
                                        document.getElementById('date-' + timeid).style.right = newwidth;
                                        timeid++;
                                    }
                                    else {
                                        let idoftime = "time-" + timeid;
                                        var marginid = document.getElementById(idoftime);
                                        var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                        var intwidth = parseInt(msgwidth);
                                        intwidth = intwidth - 20;
                                        intwidth = intwidth.toString()
                                        var newwidth = intwidth + "px";
                                        document.getElementById('date-' + timeid).style.right = newwidth;
                                        timeid++;
                                    }
                                } else {
                                    if (unreadmessage && unreadnotdisplayed) {
                                        $(".chat-log").append(
                                            `<div class='unread-break-line'>` +
                                            `<span style='text-align: center;'>` +
                                            NewMessage +
                                            `</span>` +
                                            `</div>`);
                                        $(".unread-break-line").show();
                                        unreadnotdisplayed = false;
                                    }
                                    $(".chat-log").append(
                                        `<div class='chat-wrapper' style="float: left; margin-left: 25px;">` +
                                        `<div class='incoming-msg-img'>` + avatarofchatlog + `</div>` +
                                        `<div class='${cssClass}' id='time-${timeid}'>` +
                                        `<div class='msgimg'>` +
                                        `<img id="msg_img" src="{% static 'app/images/images.png' %}">` +
                                        `<div class='msgimgname'>` +
                                        text +
                                        `<br>` +
                                        `<div class='msgimginfo'>` +
                                        fileinfo +
                                        `</div>` +
                                        `</div>` +
                                        `</div>` +
                                        `</div>` +
                                        `<span class='time_date' id='date-${timeid}'>` +
                                        time +
                                        `</span>` +
                                        `</div>`);
                                    if (iftime.match(date)) {
                                        let idoftime = "time-" + timeid;
                                        var marginid = document.getElementById(idoftime);
                                        var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                        var intwidth = parseInt(msgwidth);
                                        intwidth = intwidth - 40;
                                        intwidth = intwidth.toString()
                                        var newwidth = intwidth + "px";
                                        document.getElementById('date-' + timeid).style.left = newwidth;
                                        timeid++;
                                    }
                                    else {
                                        let idoftime = "time-" + timeid;
                                        var marginid = document.getElementById(idoftime);
                                        var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                        var intwidth = parseInt(msgwidth);
                                        intwidth = intwidth - 20;
                                        intwidth = intwidth.toString()
                                        var newwidth = intwidth + "px";
                                        document.getElementById('date-' + timeid).style.left = newwidth;

                                        timeid++;
                                    }
                                }
                            }
                            else if (extension == 'mov' || extension == 'mp4' || extension == 'wmv' || extension == 'avi' || extension == 'flv' || extension == 'mkv' || extension == 'mpeg') {
                                fileinfo = fileinfo + " Video";
                                $(".list-of-files").append(
                                    `<li>
            		                <a> 
                                    <span class="file_image"><img id="vid" src="{% static 'app/images/movies.png' %}"></span>` +
                                    text +
                                    `</a>
        	                        </li>`)
                                if (cssClass == 'outgoing') {
                                    $(".chat-log").append(
                                        `<div class='chat-wrapper' style="float: right; margin-right: 25px;">` +
                                        `<div class='outgoing-msg-img'>` + avatarofchatlog + `</div>` +
                                        `<div class='${cssClass}' id='time-${timeid}'>` +
                                        `<div class='msgimg'>` +
                                        `<img id="msg_vid" src="{% static 'app/images/movies.png' %}">` +
                                        `<div class='msgimgname'>` +
                                        text +
                                        `<br>` +
                                        `<div class='msgimginfo'>` +
                                        fileinfo +
                                        `</div>` +
                                        `</div>` +
                                        `</div>` +
                                        `</div>` +
                                        `<span class='time_date'id='date-${timeid}' style="">` +
                                        time +
                                        `</span>` +
                                        `</div>`);
                                    if (iftime.match(date)) {
                                        let idoftime = "time-" + timeid;
                                        var marginid = document.getElementById(idoftime);
                                        var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                        var intwidth = parseInt(msgwidth);
                                        intwidth = intwidth - 40;
                                        intwidth = intwidth.toString()
                                        var newwidth = intwidth + "px";
                                        document.getElementById('date-' + timeid).style.right = newwidth;
                                        timeid++;
                                    }
                                    else {
                                        let idoftime = "time-" + timeid;
                                        var marginid = document.getElementById(idoftime);
                                        var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                        var intwidth = parseInt(msgwidth);
                                        intwidth = intwidth - 20;
                                        intwidth = intwidth.toString()
                                        var newwidth = intwidth + "px";
                                        document.getElementById('date-' + timeid).style.right = newwidth;
                                        timeid++;
                                    }
                                } else {
                                    if (unreadmessage && unreadnotdisplayed) {
                                        $(".chat-log").append(
                                            `<div class='unread-break-line'>` +
                                            `<span style='text-align: center;'>` +
                                            NewMessage +
                                            `</span>` +
                                            `</div>`);
                                        $(".unread-break-line").show();
                                        unreadnotdisplayed = false;
                                    }
                                    $(".chat-log").append(
                                        `<div class='chat-wrapper' style="float: left; margin-left: 25px;">` +
                                        `<div class='incoming-msg-img'>` + avatarofchatlog + `</div>` +
                                        `<div class='${cssClass}' id='time-${timeid}'>` +
                                        `<div class='msgimg'>` +
                                        `<img id="msg_vid" src="{% static 'app/images/movies.png' %}">` +
                                        `<div class='msgimgname'>` +
                                        text +
                                        `<br>` +
                                        `<div class='msgimginfo'>` +
                                        fileinfo +
                                        `</div>` +
                                        `</div>` +
                                        `</div>` +
                                        `</div>` +
                                        `<span class='time_date' id='date-${timeid}'>` +
                                        time +
                                        `</span>` +
                                        `</div>`);
                                    if (iftime.match(date)) {
                                        let idoftime = "time-" + timeid;
                                        var marginid = document.getElementById(idoftime);
                                        var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                        var intwidth = parseInt(msgwidth);
                                        intwidth = intwidth - 40;
                                        intwidth = intwidth.toString()
                                        var newwidth = intwidth + "px";
                                        document.getElementById('date-' + timeid).style.left = newwidth;
                                        timeid++;
                                    }
                                    else {
                                        let idoftime = "time-" + timeid;
                                        var marginid = document.getElementById(idoftime);
                                        var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                        var intwidth = parseInt(msgwidth);
                                        intwidth = intwidth - 20;
                                        intwidth = intwidth.toString()
                                        var newwidth = intwidth + "px";
                                        document.getElementById('date-' + timeid).style.left = newwidth;

                                        timeid++;
                                    }
                                }
                            }
                            else {
                                fileinfo = fileinfo + " File";
                                $(".list-of-files").append(
                                    `<li>
            		                <a> 
                                    <span class="file_image"><img id="etc" src="{% static 'app/images/file.png' %}"></span>` +
                                    text +
                                    `</a>
        	                        </li>`)
                                if (cssClass == 'outgoing') {
                                    $(".chat-log").append(
                                        `<div class='chat-wrapper' style="float: right; margin-right: 25px;">` +
                                        `<div class='outgoing-msg-img'>` + avatarofchatlog + `</div>` +
                                        `<div class='${cssClass}' id='time-${timeid}'>` +
                                        `<div class='msgimg'>` +
                                        `<img id="msg_etc" src="{% static 'app/images/file.png' %}">` +
                                        `<div class='msgimgname'>` +
                                        text +
                                        `<br>` +
                                        `<div class='msgimginfo'>` +
                                        fileinfo +
                                        `</div>` +
                                        `</div>` +
                                        `</div>` +
                                        `</div>` +
                                        `<span class='time_date'id='date-${timeid}' style="">` +
                                        time +
                                        `</span>` +
                                        `</div>`);
                                    if (iftime.match(date)) {
                                        let idoftime = "time-" + timeid;
                                        var marginid = document.getElementById(idoftime);
                                        var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                        var intwidth = parseInt(msgwidth);
                                        intwidth = intwidth - 40;
                                        intwidth = intwidth.toString()
                                        var newwidth = intwidth + "px";
                                        document.getElementById('date-' + timeid).style.right = newwidth;
                                        timeid++;
                                    }
                                    else {
                                        let idoftime = "time-" + timeid;
                                        var marginid = document.getElementById(idoftime);
                                        var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                        var intwidth = parseInt(msgwidth);
                                        intwidth = intwidth - 20;
                                        intwidth = intwidth.toString()
                                        var newwidth = intwidth + "px";
                                        document.getElementById('date-' + timeid).style.right = newwidth;
                                        timeid++;
                                    }
                                } else {
                                    if (unreadmessage && unreadnotdisplayed) {

                                        $(".chat-log").append(
                                            `<div class='unread-break-line'>` +
                                            `<span style='text-align: center;'>` +
                                            NewMessage +
                                            `</span>` +
                                            `</div>`);
                                        $(".unread-break-line").show();
                                        unreadnotdisplayed = false;
                                    }
                                    $(".chat-log").append(
                                        `<div class='chat-wrapper' style="float: left; margin-left: 25px;">` +
                                        `<div class='incoming-msg-img'>` + avatarofchatlog + `</div>` +
                                        `<div class='${cssClass}' id='time-${timeid}'>` +
                                        `<div class='msgimg'>` +
                                        `<img id="msg_etc" src="{% static 'app/images/file.png' %}">` +
                                        `<div class='msgimgname'>` +
                                        text +
                                        `<br>` +
                                        `<div class='msgimginfo'>` +
                                        fileinfo +
                                        `</div>` +
                                        `</div>` +
                                        `</div>` +
                                        `</div>` +
                                        `<span class='time_date' id='date-${timeid}'>` +
                                        time +
                                        `</span>` +
                                        `</div>`);
                                    if (iftime.match(date)) {
                                        let idoftime = "time-" + timeid;
                                        var marginid = document.getElementById(idoftime);
                                        var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                        var intwidth = parseInt(msgwidth);
                                        intwidth = intwidth - 40;
                                        intwidth = intwidth.toString()
                                        var newwidth = intwidth + "px";
                                        document.getElementById('date-' + timeid).style.left = newwidth;
                                        timeid++;
                                    }
                                    else {
                                        let idoftime = "time-" + timeid;
                                        var marginid = document.getElementById(idoftime);
                                        var msgwidth = document.getElementById('time-' + timeid).clientWidth;
                                        var intwidth = parseInt(msgwidth);
                                        intwidth = intwidth - 20;
                                        intwidth = intwidth.toString()
                                        var newwidth = intwidth + "px";
                                        document.getElementById('date-' + timeid).style.left = newwidth;

                                        timeid++;
                                    }
                                }
                            }

                        }

                        showDefaultAvatar();
                        break;

                    case 1:
                        // Warning / Advice messages
                        ok_msg =
                            "<div class='contextual-message text-warning'>" +
                            data.message +
                            "</div>";
                        break;
                    case 2:
                        // Alert / Danger messages
                        ok_msg =
                            "<div class='contextual-message text-danger'>" +
                            data.message +
                            "</div>";
                        break;
                    case 3:
                        // "Muted" messages
                        ok_msg =
                            "<div class='contextual-message text-muted'>" +
                            data.message +
                            "</div>";
                        break;
                    case 4:
                        // User joined room
                        break;
                    case 5:
                        // User left room
                        break;
                    case "created":
                        var obj = data.name;
                        var me = $("#myself").val() + ", ";
                        var me2 = ", " + $("#myself").val();
                        var comma = obj.replace(/-/g, ', ');
                        var new_string = comma.replace(me, "");
                        new_string = new_string.replace(me2, "");
                        new_string = "me, " + new_string;

                        //me = extra + $("#myself").val();
                        //new_string = new_string.replace(me, "");

                        let avatardivcreate = ""

                        function avatarhtml(userdata) {
                            let avatar = '<div class="profile-pic-wrapper" data-username="' + userdata.username + '" data-bgcolor="' + userdata.default + '">';
                            if (userdata.avatar) {
                                avatar += '<img class="profile-pic" src="' + userdata.avatar + '">';

                            }
                            avatar += '</div>';
                            //let avatar = userdata.avatar ? '<img class="profile-pic" src="' + userdata.avatar + '">' : '<div class="profile-pic-wrapper" data-username="' + userdata.username + '" data-bgcolor="' + userdata.default + '"></div>'

                            return avatar
                        }
                        for (var i = 0; i < data.avatars.length; i++) {
                            /*if (data.avatars[i].username == $("#myself").val()) {
                                continue
                            }*/
                            if (i > 2) {
                                break
                            }
                            avatardivcreate += avatarhtml(data.avatars[i])

                        }

                        avatararray[a] = {
                            "group_avatar": avatardivcreate,
                            "group_id": data.room
                        }
                        a++;

                        let extraUserscreate = data.avatars.length - i;

                        $(".rooms").append(
                            `<li id="room-link" class="room-link" data-room-id="${data.room}" name="${data.room}">
                            <div class="wrap">
                                <div avatar-value="${data.room}" class="avatars">
                                ${avatardivcreate}
                                </div>
                                <div class="room-details">
                                    <span style="overflow: hidden;white-space: nowrap;text-overflow: ellipsis;" room-name-value="${data.room}" class="name-of-room" id="name-of-room">${new_string}</span>
                                    <p message-preview-value="${data.room}" class="preview">${data.message}</p>
                                </div>
                                <span
                                ellipsis-value="${data.room}" id="ellipsis-${data.room}" class="las la-ellipsis-v ellipsis">
                                    </span>
                                <div class="chat-dropdown"> 
                                   
                                    <div chat-dropdown-value="${data.room}" class="chat-dropdown-content">
                                    <a edit-button-value="${data.room}" class="edit-button" id="edit-${data.room}">Edit Name</a>
                                    <a delete-button-value="${data.room}" class="delete-button" id="delete-${data.room}">Delete Room</a>
                                    </div>
                                </div>
                            </div>

                        </li>`);
                        if ($("#myself").val() != data.created_by) {
                            var noticeofcreatedchat = document.getElementById("chatAudio");
                            var newroom = $("li[data-room-id=" + data.room + "]")[0];
                            console.log("new", newroom);
                            $(newroom).addClass("unread");
                            noticeofcreatedchat.play();
                            socket.send(
                                JSON.stringify({
                                    command: "acknowledged",
                                    room: data.room,
                                })
                            );

                        }
                        //maybe it's this that causes the problem
                        showDefaultAvatar();
                        editbuttonclicked(`ellipsis-${data.room}`);
                        menuclicked(`delete-${data.room}`, `edit-${data.room}`);

                        break;
                    case "room_exists":
                        $("li[data-room-id=" + data.room_id + "]")[0].click();
                        break;
                    case "sent_to_others":
                        if (roomId !== data.room) {

                            socket.send(
                                JSON.stringify({
                                    command: "create_unread",
                                    room: data.room,
                                    messageId: data.message,
                                    messagestring: data.messagestring,
                                    notice: data.is_notice,
                                })
                            );

                        }
                        break;
                    case "get_unread":
                        var unreadroom = $("li[data-room-id=" + data.unread.room + "]")[0];
                        var otherppl = document.getElementById("chatAudio");
                        otherppl.play();
                        $(unreadroom).addClass("unread");
                        if (!data.unread.is_notice) {
                            $("[message-preview-value=" + data.unread.room + "]").html("");
                            $("[message-preview-value=" + data.unread.room + "]").html(data.unread.message);
                        }
                        else {
                            $("[message-preview-value=" + data.unread.room + "]").html("");
                            $("[message-preview-value=" + data.unread.room + "]").html(noticeMessage);
                        }
                        socket.send(
                            JSON.stringify({
                                command: "acknowledged",
                                room: data.unread.room,
                            })
                        );
                        break;
                    case "get_members":
                        var people = data.member
                        let avatarofmembers = people.avatar ? '<img class="profile-pic" src="' + people.avatar + '">' : '<div class="profile-pic-wrapper" style="display: inline; width: 10%;" data-username="' + people.username + '" data-bgcolor="' + people.default + '"></div>'


                        // $(".avatar-list").append(
                        //`<li><img src="" alt="user" class="profile-photo-lg"></li>`
                        // );

                        if (!people.solitary) {

                            $("#upload-photos-button").show();
                            $(".msg_send_btn").show();
                            $("#typed_msg").show();
                            $("#add-members").show();

                            $(".list-of-members").append(
                                `       <li>
                                    <span class="profile-link">${avatarofmembers}<div online-link-id="${people.id}" class="online_icon"></div><p class="profile-name" data-member-name="${people.username}">${people.username}</p><i data-id="${people.id}" id="user-${people.id}"  class="las la-minus remove-button"></i></span>
        	            </li>`

                            );
                            nameofmembers[xisweird] = people.username;
                            xisweird++;

                            /*$(".remove-buttons").append(
                                `<li style="padding-bottom: 18px;"><button data-id="${people.id}" class="remove-user">Remove User</button>
                                    </li>`      //attach user id to remove button
                            );*/
                            showDefaultAvatar();
                            removeduserclicked(`user-${people.id}`);
                        }
                        else {
                            $("#upload-photos-button").hide();
                            $(".msg_send_btn").hide();
                            $("#typed_msg").hide();
                            $("#add-members").hide();
                            $(".list-of-members").empty();

                        }
                        break;
                    case "delete_room":
                        removedelement = $("li[data-room-id=" + data.room + "]")[0];
                        var list = document.getElementById("rooms");
                        var obj = data.name;
                        var me = $("#myself").val();
                        if (obj.match(me)) {
                            me = $("#myself").val() + ", ";
                            me2 = ", " + $("#myself").val();
                            var comma = obj.replace(/-/g, ', ');
                            var new_string = comma.replace(me, "");
                            new_string = new_string.replace(me2, "");
                            new_string = "me, " + new_string;
                            new_string = new_string.replace(/-deleted/g, "");
                            new_string = new_string.replace(/-removed/g, "");
                            new_string = new_string.replace(/-additional/g, "");
                            new_string = new_string.replace(/, deleted/g, "");
                            new_string = new_string.replace(/, additional/g, "");
                            new_string = new_string.replace(/, removed/g, "");
                        }
                        else {
                            var new_string = obj.replace(/-deleted/g, "");
                            new_string = new_string.replace(/-removed/g, "");
                            new_string = new_string.replace(/-additional/g, "");
                            new_string = new_string.replace(/, deleted/g, "");
                            new_string = new_string.replace(/, additional/g, "");
                            new_string = new_string.replace(/, removed/g, "");
                        }
                        let counterdelete = 0;
                        let avatardelete = ""

                        function avatarhtml(userdata) {
                            let avatar = '<div class="profile-pic-wrapper" data-username="' + userdata.username + '" data-bgcolor="' + userdata.default + '">';
                            if (userdata.avatar) {
                                avatar += '<img class="profile-pic" src="' + userdata.avatar + '">';

                            }
                            avatar += '</div>';
                            //let avatar = userdata.avatar ? '<img class="profile-pic" src="' + userdata.avatar + '">' : '<div class="profile-pic-wrapper" data-username="' + userdata.username + '" data-bgcolor="' + userdata.default + '"></div>'

                            return avatar
                        }
                        for (var i = 0; i < data.avatars.length; i++) {

                            // Only show avatars for the first three users in the chat
                            if (data.avatars[i].username == $("#myself").val()) {
                                continue
                            }
                            if (counterdelete > 2) {
                                break
                            }
                            avatardelete += avatarhtml(data.avatars[i])
                            counterdelete++;
                        }

                        for (var i = 0; i < avatararray.length; i++) {
                            av = avatararray[i];
                            if (av.group_id == data.room) {
                                avatararray[i] = {
                                    "group_avatar": avatardelete,
                                    "group_id": data.room
                                }
                                break;
                            }
                        }

                        let extraUsersAvatarDelete = data.avatars.length - i;
                        if ($("#myself").val() == data.removed_user && roomId == data.room) {
                            socket.send(
                                JSON.stringify({
                                    command: "leave",
                                    room: data.room,
                                })
                            );

                            $("#title-img").hide();
                            $("#typed_msg").hide();
                            $("#upload-photos-button").hide();
                            $(".msg_send_btn").hide();
                            $(".user-header").show();
                            $(".user-header p").hide();
                            $("#tag-input").hide();
                            $("#users-list").hide();
                            $("#chat-name").hide();
                            $(".chat-log").empty();
                            $(".rightAccordion").hide();
                            $(".rightPanel").hide();
                            $("#add-members").hide();
                            $("#create-chat").show();
                            $("#avatars").empty();

                            list.removeChild(removedelement);
                        }
                        else if ($("#myself").val() == data.removed_user && roomId != data.room) {
                            list.removeChild(removedelement);
                        }

                        else if ($("#myself").val() != data.removed_user) {

                            if (data.edited && roomId == data.room) {
                                wasclicked = false;
                                /*socket.send(
                                    JSON.stringify({
                                        command: "leave",
                                        room: data.room,
                                    })
                                );*/
                                socket.send(
                                    JSON.stringify({
                                        command: "join",
                                        room: data.room,
                                        "wasclicked": wasclicked,
                                    })
                                );
                                $("[avatar-value=" + data.room + "]").html("");
                                $("[avatar-value=" + data.room + "]").html(avatardelete);
                                $("#avatar").empty();
                                $("#avatar").append(avatardelete);
                                $(".list-of-members").empty();
                                socket.send(
                                    JSON.stringify({
                                        command: "members",
                                        room: data.room,
                                    })
                                );

                            }
                            else if (!data.edited && roomId == data.room) {
                                wasclicked = false;
                                /*socket.send(
                                    JSON.stringify({
                                        command: "leave",
                                        room: data.room,
                                    })
                                );*/
                                socket.send(
                                    JSON.stringify({
                                        command: "join",
                                        room: data.room,
                                        "wasclicked": wasclicked,
                                    })
                                );
                                $("[avatar-value=" + data.room + "]").html("");
                                $("[avatar-value=" + data.room + "]").html(avatardelete);
                                $("#avatar").empty();
                                $("#avatar").append(avatardelete);
                                $("[room-name-value=" + data.room + "]").html("");
                                $("[room-name-value=" + data.room + "]").html(new_string);
                                $(".room-title").html("");
                                $(".room-title").html(new_string);
                                $(".list-of-members").empty();
                                socket.send(
                                    JSON.stringify({
                                        command: "members",
                                        room: data.room,
                                    })
                                );
                            }
                            else if (!data.edited && roomId != data.room) {
                                $("[avatar-value=" + data.room + "]").html("");
                                $("[avatar-value=" + data.room + "]").html(avatardelete);
                                $("[room-name-value=" + data.room + "]").html("");
                                $("[room-name-value=" + data.room + "]").html(new_string);
                            }
                            else if (data.edited && roomId != data.room) {
                                $("[avatar-value=" + data.room + "]").html("");
                                $("[avatar-value=" + data.room + "]").html(avatardelete);
                            }
                        }
                        //menuclicked(`delete-${data.room}`, `edit-${data.room}`);
                        showDefaultAvatar();
                        break;
                    case "get_users":

                        var allusers = data.user
                        //let avatarofusers = allusers.avatar ? '<img class="profile-pic" src="' + allusers.avatar + '">' : '<div class="profile-pic-wrapper" style="display: inline; width: 10%;" data-username="' + allusers.username + '" data-bgcolor="' + allusers.default + '"></div>'

                        memberlist[y] = {
                            value: allusers.id,
                            name: allusers.username,
                            email: allusers.email,
                            avatar: allusers.avatar,
                            default: allusers.default
                        }
                        y++;

                        //populate();
                        break;
                    case "get_additional":

                        //var newTitle = data.adder
                        var list = document.getElementById("rooms");
                        var obj = data.name;
                        var me = $("#myself").val();
                        if (obj.match(me)) {
                            me = $("#myself").val() + ", ";
                            me2 = ", " + $("#myself").val();
                            var comma = obj.replace(/-/g, ', ');
                            var new_string = comma.replace(me, "");
                            new_string = new_string.replace(me2, "");
                            new_string = "me, " + new_string;
                            new_string = new_string.replace(/-deleted/g, "");
                            new_string = new_string.replace(/-removed/g, "");
                            new_string = new_string.replace(/-additional/g, "");
                            new_string = new_string.replace(/, deleted/g, "");
                            new_string = new_string.replace(/, additional/g, "");
                            new_string = new_string.replace(/, removed/g, "");
                        }
                        else {
                            var new_string = obj.replace(/-deleted/g, "");
                            new_string = new_string.replace(/-removed/g, "");
                            new_string = new_string.replace(/-additional/g, "");
                            new_string = new_string.replace(/, deleted/g, "");
                            new_string = new_string.replace(/, additional/g, "");
                            new_string = new_string.replace(/, removed/g, "");
                        }
                        let avataradditional = ""
                        let counteradditional = 0;

                        function avatarhtml(userdata) {
                            let avatar = '<div class="profile-pic-wrapper" data-username="' + userdata.username + '" data-bgcolor="' + userdata.default + '">';
                            if (userdata.avatar) {
                                avatar += '<img class="profile-pic" src="' + userdata.avatar + '">';

                            }
                            avatar += '</div>';
                            //let avatar = userdata.avatar ? '<img class="profile-pic" src="' + userdata.avatar + '">' : '<div class="profile-pic-wrapper" data-username="' + userdata.username + '" data-bgcolor="' + userdata.default + '"></div>'

                            return avatar
                        }
                        for (var i = 0; i < data.avatars.length; i++) {

                            // Only show avatars for the first three users in the chat
                            /*if (data.avatars[i].username == $("#myself").val()) {
                                continue
                            }*/
                            if (counteradditional > 2) {
                                break
                            }
                            avataradditional += avatarhtml(data.avatars[i])
                            counteradditional++;
                        }
                        for (var i = 0; i < avatararray.length; i++) {
                            av = avatararray[i];
                            if (av.group_id == data.room) {
                                avatararray[i] = {
                                    "group_avatar": avataradditional,
                                    "group_id": data.room
                                }
                                avatarsexist = true;
                                break;
                            }

                        }
                        if (!avatarsexist) {
                            var r = avatararray.length;
                            avatararray[r] = {
                                "group_avatar": avataradditional,
                                "group_id": data.room
                            }
                        }
                        let extraUsersAvatarAdd = data.avatars.length - i;
                        //let text = (data.message.text) ? data.message.text : data.message;

                        roomexists = ($("li[data-room-id=" + data.room + "]")[0]) ? true : false;

                        if (roomexists == true) {
                            if (data.edited && roomId == data.room) {
                                wasclicked = false;
                                /*socket.send(
                                    JSON.stringify({
                                        command: "leave",
                                        room: data.room,
                                    })
                                );*/
                                socket.send(
                                    JSON.stringify({
                                        command: "join",
                                        room: data.room,
                                        "wasclicked": wasclicked,
                                    })
                                );
                                $("[avatar-value=" + data.room + "]").html("");
                                $("[avatar-value=" + data.room + "]").html(avataradditional);
                                $("#avatar").empty();
                                $("#avatar").append(avataradditional);
                                $(".list-of-members").empty();
                                socket.send(
                                    JSON.stringify({
                                        command: "members",
                                        room: data.room,
                                    })
                                );
                            }
                            else if (!data.edited && roomId == data.room) {
                                wasclicked = false;
                                /*socket.send(
                                    JSON.stringify({
                                        command: "leave",
                                        room: data.room,
                                    })
                                );*/
                                socket.send(
                                    JSON.stringify({
                                        command: "join",
                                        room: data.room,
                                        "wasclicked": wasclicked,
                                    })
                                );
                                $("[room-name-value=" + data.room + "]").html("");
                                $("[room-name-value=" + data.room + "]").html(new_string);
                                $(".room-title").html("");
                                $(".room-title").html(new_string);
                                $("[avatar-value=" + data.room + "]").html("");
                                $("[avatar-value=" + data.room + "]").html(avataradditional);
                                $("#avatar").empty();
                                $("#avatar").append(avataradditional);
                                $(".list-of-members").empty();
                                socket.send(
                                    JSON.stringify({
                                        command: "members",
                                        room: data.room,
                                    })
                                );
                            }
                            else if (!data.edited && roomId != data.room) {
                                $("[room-name-value=" + data.room + "]").html("");
                                $("[room-name-value=" + data.room + "]").html(new_string);
                                $("[avatar-value=" + data.room + "]").html("");
                                $("[avatar-value=" + data.room + "]").html(avataradditional);
                            }
                            else if (data.edited && roomId != data.room) {
                                $("[avatar-value=" + data.room + "]").html("");
                                $("[avatar-value=" + data.room + "]").html(avataradditional);
                            }

                        }
                        else {

                            $(".rooms").append(
                                `<li id="room-link" class="room-link" data-room-id="${data.room}" name="${data.room}">
                                        <div class="wrap">
                                            <div avatar-value="${data.room}" class="avatars">
                                                ${avataradditional}
                                            </div>
                                            <div class="room-details">
                                                <span style="overflow: hidden;white-space: nowrap;text-overflow: ellipsis;" room-name-value="${data.room}" class="name-of-room" id="name-of-room">${new_string}</span>
                                                <p message-preview-value="${data.room}" class="preview">${data.preview}</p>
                                            </div>
                                            <span
                                                ellipsis-value="${data.room}" id="ellipsis-${data.room}" class="las la-ellipsis-v ellipsis">
                                                </span>
                                            <div class="chat-dropdown"> 
                                                
                                                <div chat-dropdown-value="${data.room}" class="chat-dropdown-content">

                                                <a edit-button-value="${data.room}" class="edit-button" id="edit-${data.room}">Edit Name</a>
                                                <a delete-button-value="${data.room}" class="delete-button" id="delete-${data.room}">Delete Room</a>
                                                        </div>
                                            </div>
                                        </div>

                                        </li>`);
                            editbuttonclicked(`ellipsis-${data.room}`);
                            menuclicked(`delete-${data.room}`, `edit-${data.room}`);
                            var additionalroom = $("li[data-room-id=" + data.room + "]")[0];
                            $(additionalroom).addClass("unread");
                            var noticeofadditionalchat = document.getElementById("chatAudio");
                            noticeofadditionalchat.play();
                        }


                        showDefaultAvatar();
                        break;
                    case "remove_user":

                        //var newTitle = data.adder
                        let old_room = $("li[data-room-id=" + data.room + "]")[0];
                        let old_room_edit_id = $("#edit-" + data.room)[0];
                        let old_room_delete_id = $("#delete-" + data.room)[0];
                        let old_room_avatar = $("[avatar-value=" + data.room + "]")[0];
                        let old_room_name = $("[room-name-value=" + data.room + "]")[0];
                        let old_room_preview = $("[message-preview-value=" + data.room + "]")[0];
                        let old_room_ellipsis = $("[ellipsis-value=" + data.room + "]")[0];
                        let old_room_dropdown = $("[chat-dropdown-value=" + data.room + "]")[0];
                        let old_room_edit_button = $("[edit-button-value=" + data.room + "]")[0];
                        let old_room_delete_button = $("[delete-button-value=" + data.room + "]")[0];
                        let old_room_ellipsis_id = $("span[ellipsis-value=" + data.room + "]")[0];
                        var obj = data.name;
                        var me = $("#myself").val();
                        if (obj.match(me)) {
                            me = $("#myself").val() + ", ";
                            me2 = ", " + $("#myself").val();
                            var comma = obj.replace(/-/g, ', ');
                            var new_string = comma.replace(me, "");
                            new_string = new_string.replace(me2, "");
                            new_string = "me, " + new_string;
                            new_string = new_string.replace(/-deleted/g, "");
                            new_string = new_string.replace(/-removed/g, "");
                            new_string = new_string.replace(/-additional/g, "");
                            new_string = new_string.replace(/, deleted/g, "");
                            new_string = new_string.replace(/, additional/g, "");
                            new_string = new_string.replace(/, removed/g, "");
                        }
                        else {
                            var new_string = obj.replace(/-deleted/g, "");
                            new_string = new_string.replace(/-removed/g, "");
                            new_string = new_string.replace(/-additional/g, "");
                            new_string = new_string.replace(/, deleted/g, "");
                            new_string = new_string.replace(/, additional/g, "");
                            new_string = new_string.replace(/, removed/g, "");
                        }
                        let avatarremove = ""
                        let counterremove = 0;

                        function avatarhtml(userdata) {
                            let avatar = '<div class="profile-pic-wrapper" data-username="' + userdata.username + '" data-bgcolor="' + userdata.default + '">';
                            if (userdata.avatar) {
                                avatar += '<img class="profile-pic" src="' + userdata.avatar + '">';

                            }
                            avatar += '</div>';
                            //let avatar = userdata.avatar ? '<img class="profile-pic" src="' + userdata.avatar + '">' : '<div class="profile-pic-wrapper" data-username="' + userdata.username + '" data-bgcolor="' + userdata.default + '"></div>'

                            return avatar
                        }

                        for (var i = 0; i < data.avatars.length; i++) {

                            if ($("#myself").val() != data.removed_user) {
                                // Only show avatars for the first three users in the chat
                                /*if (data.avatars[i].username == $("#myself").val()) {
                                    continue
                                }*/
                                if (counterremove > 2) {
                                    break
                                }
                                avatarremove += avatarhtml(data.avatars[i])
                                counterremove++;
                            }
                            else {
                                avatarremove += avatarhtml(data.avatars[i])
                                break
                            }

                        }
                        if ($("#myself").val() == data.removed_user) {
                            avatararray[a] = {
                                "group_avatar": avatarremove,
                                "group_id": data.new_room
                            }
                            a++;
                        }
                        else {
                            avatararray[a] = {
                                "group_avatar": avatarremove,
                                "group_id": data.room
                            }
                            a++;
                        }
                        let extraUsersAvatarRemove = data.avatars.length - i;

                        if ($("#myself").val() == data.removed_user && roomId == data.room) {
                            socket.send(
                                JSON.stringify({
                                    command: "leave",
                                    room: data.room,
                                })
                            );
                            $("[avatar-value=" + data.new_room + "]").html("");
                            $("[avatar-value=" + data.new_room + "]").html(avatarremove);
                            $("#avatar").empty();
                            $("#avatar").append(avatarremove);
                            old_room.setAttribute("name", data.new_room);
                            old_room.setAttribute("data-room-id", data.new_room);
                            old_room_name.setAttribute("room-name-value", data.new_room);
                            old_room_preview.setAttribute("message-preview-value", data.new_room);
                            old_room_ellipsis.setAttribute("ellipsis-value", data.new_room);
                            old_room_dropdown.setAttribute("chat-dropdown-value", data.new_room);
                            old_room_edit_button.setAttribute("edit-button-value", data.new_room);
                            old_room_delete_button.setAttribute("delete-button-value", data.new_room);
                            old_room_avatar.setAttribute("avatar-value", data.new_room);
                            old_room_ellipsis_id.setAttribute("id", "ellipsis-" + data.new_room);
                            old_room_edit_id.setAttribute("id", "edit-" + data.new_room);
                            old_room_delete_id.setAttribute("id", "delete-" + data.new_room);

                            $(".list-of-members").empty();
                            socket.send(
                                JSON.stringify({
                                    command: "members",
                                    room: data.new_room,
                                })
                            );
                            //editbuttonclicked(`ellipsis-${data.new_room}`);
                            //menuclicked(`delete-${data.new_room}`, `edit-${data.new_room}`);
                        }
                        else if ($("#myself").val() == data.removed_user && roomId != data.room) {
                            $("[avatar-value=" + data.new_room + "]").html("");
                            $("[avatar-value=" + data.new_room + "]").html(avatarremove);


                            old_room.setAttribute("name", data.new_room);
                            old_room.setAttribute("data-room-id", data.new_room);
                            old_room_name.setAttribute("room-name-value", data.new_room);
                            old_room_preview.setAttribute("message-preview-value", data.new_room);
                            old_room_ellipsis.setAttribute("ellipsis-value", data.new_room);
                            old_room_dropdown.setAttribute("chat-dropdown-value", data.new_room);
                            old_room_edit_button.setAttribute("edit-button-value", data.new_room);
                            old_room_delete_button.setAttribute("delete-button-value", data.new_room);
                            old_room_avatar.setAttribute("avatar-value", data.new_room);
                            old_room_ellipsis_id.setAttribute("id", "ellipsis-" + data.new_room);
                            old_room_edit_id.setAttribute("id", "edit-" + data.new_room);
                            old_room_delete_id.setAttribute("id", "delete-" + data.new_room);


                            //editbuttonclicked(`ellipsis-${data.new_room}`);
                            //menuclicked(`delete-${data.new_room}`, `edit-${data.new_room}`);
                        }
                        else if ($("#myself").val() != data.removed_user) {
                            if (data.edited && roomId == data.room) {
                                wasclicked = false
                                /*socket.send(
                                    JSON.stringify({
                                        command: "leave",
                                        room: data.room,
                                    })
                                );*/
                                socket.send(
                                    JSON.stringify({
                                        command: "join",
                                        room: data.room,
                                        "wasclicked": wasclicked,
                                    })
                                );
                                $("[avatar-value=" + data.room + "]").html("");
                                $("[avatar-value=" + data.room + "]").html(avatarremove);
                                $("#avatar").empty();
                                $("#avatar").append(avatarremove);
                                $(".list-of-members").empty();
                                socket.send(
                                    JSON.stringify({
                                        command: "members",
                                        room: data.room,
                                    })
                                );
                            }
                            else if (!data.edited && roomId == data.room) {
                                wasclicked = false;
                                /*socket.send(
                                    JSON.stringify({
                                        command: "leave",
                                        room: data.room,
                                    })
                                );*/
                                socket.send(
                                    JSON.stringify({
                                        command: "join",
                                        room: data.room,
                                        "wasclicked": wasclicked,
                                    })
                                );
                                $("[avatar-value=" + data.room + "]").html("");
                                $("[avatar-value=" + data.room + "]").html(avatarremove);
                                $("#avatar").empty();
                                $("#avatar").append(avatarremove);
                                $("[room-name-value=" + data.room + "]").html("");
                                $("[room-name-value=" + data.room + "]").html(new_string);
                                $(".room-title").html("");
                                $(".room-title").html(new_string);
                                $(".list-of-members").empty();
                                socket.send(
                                    JSON.stringify({
                                        command: "members",
                                        room: data.room,
                                    })
                                );
                            }
                            else if (!data.edited && roomId != data.room) {
                                $("[avatar-value=" + data.room + "]").html("");
                                $("[avatar-value=" + data.room + "]").html(avatarremove);
                                $("[room-name-value=" + data.room + "]").html("");
                                $("[room-name-value=" + data.room + "]").html(new_string);
                            }
                            else if (data.edited && roomId != data.room) {
                                $("[avatar-value=" + data.room + "]").html("");
                                $("[avatar-value=" + data.room + "]").html(avatarremove);
                            }
                        }

                        showDefaultAvatar();
                        break;

                    case "get_rooms":
                        roomie = data.rooms;
                        let o = 0;
                        allRooms[o] = roomie.id;
                        o++;

                        var obj = roomie.name;
                        var me = $("#myself").val();
                        if (obj.match(me)) {
                            me = $("#myself").val() + ", ";
                            me2 = ", " + $("#myself").val();
                            var comma = obj.replace(/-/g, ', ');
                            var new_string = comma.replace(me, "");
                            new_string = new_string.replace(me2, "");
                            new_string = "me, " + new_string;
                            new_string = new_string.replace(/-deleted/g, "");
                            new_string = new_string.replace(/-removed/g, "");
                            new_string = new_string.replace(/-additional/g, "");
                            new_string = new_string.replace(/, deleted/g, "");
                            new_string = new_string.replace(/, additional/g, "");
                            new_string = new_string.replace(/, removed/g, "");
                        }
                        else {
                            var new_string = obj.replace(/-deleted/g, "");
                            new_string = new_string.replace(/-removed/g, "");
                            new_string = new_string.replace(/-additional/g, "");
                            new_string = new_string.replace(/, deleted/g, "");
                            new_string = new_string.replace(/, additional/g, "");
                            new_string = new_string.replace(/, removed/g, "");
                        }

                        let avatardiv = ""
                        let preview = ""
                        let counter = 0;

                        function avatarhtml(userdata) {
                            let avatar = '<div class="profile-pic-wrapper" data-username="' + userdata.username + '" data-bgcolor="' + userdata.default + '">';
                            if (userdata.avatar) {
                                avatar += '<img class="profile-pic" src="' + userdata.avatar + '">';

                            }
                            avatar += '</div>';
                            //let avatar = userdata.avatar ? '<img class="profile-pic" src="' + userdata.avatar + '">' : '<div class="profile-pic-wrapper" data-username="' + userdata.username + '" data-bgcolor="' + userdata.default + '"></div>'

                            return avatar
                        }
                        for (var i = 0; i < data.rooms.avatars.length; i++) {
                            /*<div class="profile-pic-wrapper" data-username="{{user.username}}" data-bgcolor="{{user.bgColor}}">
                            {% if user.avatar %}
                            <img class="profile-pic" src="{{user.avatar.url}}">
                            {% endif %}
                            </div>*/

                            // Only show avatars for the first three users in the chat
                            /*if (data.rooms.avatars[i].username == $("#myself").val()) {
                                continue
                            }*/
                            if (counter > 2) {
                                break
                            }
                            avatardiv += avatarhtml(data.rooms.avatars[i])
                            counter++;
                        }

                        avatararray[a] = {
                            "group_avatar": avatardiv,
                            "group_id": roomie.id
                        }
                        a++;
                        let extraUsers = data.rooms.avatars.length - i;

                        for (var j = 0; j < data.rooms.preview.length; j++) {

                            preview = data.rooms.preview[j];

                        }
                        $(".rooms").append(
                            `<li id="room-link" class="room-link" data-room-id="${roomie.id}" name="${roomie.id}">
                            <div class="wrap">
                                <div avatar-value="${roomie.id}" class="avatars">
                                ${avatardiv}
                                </div>
                                <div class="room-details">
                                    <span style="overflow: hidden;white-space: nowrap;text-overflow: ellipsis;" room-name-value="${roomie.id}" class="name-of-room" id="name-of-room">${new_string}</span>
                                    <p message-preview-value="${roomie.id}" class="preview">${preview}</p>
                                </div>
                                <span
                                     ellipsis-value="${roomie.id}" id="ellipsis-${roomie.id}" class="las la-ellipsis-v ellipsis">
                                    </span>
                                <div class="chat-dropdown">
                                            <div chat-dropdown-value="${roomie.id}" class="chat-dropdown-content dropdown-menu">
                                                <a edit-button-value="${roomie.id}" class="edit-button dropdown-item" id="edit-${roomie.id}">Edit Name</a>
                                    <a delete-button-value="${roomie.id}" class="delete-button dropdown-item" id="delete-${roomie.id}">Delete Room</a>
                                            </div>
                                </div>
                            </div>

                        </li>`);

                        if (data.rooms.unread == true) {
                            var firstunreadroom = $("li[data-room-id=" + roomie.id + "]")[0];
                            $(firstunreadroom).addClass("unread");
                            if (data.rooms.acknowledged == false) {
                                var firstnoticeofunreadchat = document.getElementById("chatAudio");
                                firstnoticeofunreadchat.play();
                                socket.send(
                                    JSON.stringify({
                                        command: "acknowledged",
                                        room: roomie.id,
                                    })
                                );
                            }
                        }

                        showDefaultAvatar();
                        editbuttonclicked(`ellipsis-${roomie.id}`);
                        menuclicked(`delete-${roomie.id}`, `edit-${roomie.id}`);
                        break;

                    case "print_title":
                        var new_title = data.room;
                        title = new_title.name;
                        break;
                    case "change_status":
                        var onlinelink = $("[online-link-id=" + data.id + "]");
                        onlinelink.css("background-color", "green");
                        break;
                    case "edit":
                        var target_li = $("li[data-room-id=" + data.room + "]")[0];
                        var nameOfChat = target_li.getElementsByTagName("span")[0];

                        if (roomId == data.room) {
                            wasclicked = false;
                            /*socket.send(
                                JSON.stringify({
                                    command: "leave",
                                    room: data.room,
                                })
                            );*/
                            socket.send(
                                JSON.stringify({
                                    command: "join",
                                    room: data.room,
                                    "wasclicked": wasclicked,
                                })
                            );
                            $(nameOfChat).html("");
                            $(nameOfChat).html(data.name);
                            $(".room-title").html("");
                            $(".room-title").html(data.name);
                        }
                        else {
                            $(nameOfChat).html("");
                            $(nameOfChat).html(data.name);
                        }
                        break;

                    default:
                        console.log("Unsupported message type!");
                        return;
                }

                $(".chat-log").html();
                if (data.msg_type != "created")
                    msgdiv.append(ok_msg);

                msgdiv.scrollTop(msgdiv.prop("scrollHeight"));
            } else {
                console.log("Cannot handle message!");
            }
        };

        $("#add-members").click(function () {
            $(".unread-break-line").hide();
            /*if (hideellipsis) {
                $("[chat-dropdown-value=" + chatDropdownId + "]").hide();
                hideellipsis = false;
            }
            else {
     
            }*/
            whitelist_2 = [];
            xisweird = 0;
            y = 0;
            z = 0;
            member = false;
            for (var j = 0; j < memberlist.length; j++) {
                var el = memberlist[j];
                for (var i = 0; i < nameofmembers.length; i++) {
                    if (el.name == nameofmembers[i]) {
                        member = true;
                    }
                }
                if (member == true) {
                    whitelist_2[z] = {

                        "value": el.value,
                        "name": el.name,
                        "avatar2": "{% static 'app/images/PngItem_4212266.png' %}",
                        "avatar": el.avatar,
                        "email": el.email,
                        "default": el.default,
                        "disabled": true,
                    }
                    member = false;
                    z++;
                }
                else {
                    whitelist_2[z] = {
                        "value": el.value,
                        "name": el.name,
                        "avatar2": "{% static 'app/images/PngItem_4212266.png' %}",
                        "avatar": el.avatar,
                        "email": el.email,
                        "default": el.default,
                        "disabled": false,
                    }

                    z++;
                }

            }
            socket.send(
                JSON.stringify({
                    command: "title",
                    room: roomId,
                })
            );

            $(".room-name").html("");
            $(".room-name").html(title);
            $("#members-page").show();

            fillarray2();

            /*
                        console.log("name", nameofmembers);
                        console.log("memberlist", memberlist);
                        console.log("whitelist", whitelist_2);
            */
        });



        // Says if we joined a room or not by if there's a div for it
        inRoom = function (roomId) {
            return $("#room-" + roomId).length > 0;
        };

        // Room join/leave

        /* -Show all saved messages when joining a room
                    -Make it if already in that room either do nothing or reload that room
                    -if not in that room leave current room, if in one, then join the
                    room that was clicked on
                    -If not in room when a message comes in give it an unread class*/



        function editbuttonclicked(buttonclicked) {
            $("#" + buttonclicked).click(function (event) {
                chatDropdownId = $(this).attr("ellipsis-value");
                let currentdropdownselector = "[chat-dropdown-value=" + chatDropdownId + "]";
                let currentdropdown = $(currentdropdownselector)
                currentdropdown.css("left", event.clientX);
                currentdropdown.css("top", event.clientY);

                ellipsisClicked = true;
                //hideellipsis = true;


                $(".chat-dropdown-content").not(currentdropdownselector).hide();

                currentdropdown.toggle();
                if ($(currentdropdownselector).is(":visible")) {
                    disableScroll();
                }
                else {

                    enableScroll();
                }


            });
        }


        function menuclicked(deletechat, edit) {
            $("#" + deletechat).click(function () {
                $(".unread-break-line").hide();
                deleteroom = $(this).attr("delete-button-value");
                //modal show
                $(".confirmation-chat-modal").show();
                $("[chat-dropdown-value=" + chatDropdownId + "]").hide();

            });
            $("#" + edit).click(function () {
                $(".unread-break-line").hide();
                editroom = $(this).attr("edit-button-value");
                //modal show
                $(".edit-chat-modal").show();



                $("[chat-dropdown-value=" + chatDropdownId + "]").hide();
            });


        }
        function removeduserclicked(userclicked) {
            $("#" + userclicked).click(function () {
                $(".unread-break-line").hide();
                removeduser = $(this).attr("data-id");
                removedusername = $(this).attr("data-member-name");
                //modal show
                $(".confirmation-modal").show();
            });
        }
        $("#confirm").click(function () {
            var noticemsg = $("#myself").val() + " has removed " + removedusername + " from the chat."
            socket.send(
                JSON.stringify({
                    command: "remove",
                    room: roomId,
                    old_user: removeduser

                })
            );
            socket.send(
                JSON.stringify({
                    "command": "send",
                    "room": roomId,
                    "message": noticemsg,
                    "from_user": $("#myself").val(),
                    "file": false,
                    "notice": true,
                })
            );
            $(".confirmation-modal").hide();
        });
        $("#confirmation").click(function () {
            var noticemsg = $("#myself").val() + " has removed themself from the chat."
            socket.send(
                JSON.stringify({
                    command: "delete",
                    room: deleteroom,
                })
            );
            socket.send(
                JSON.stringify({
                    "command": "send",
                    "room": roomId,
                    "message": noticemsg,
                    "from_user": $("#myself").val(),
                    "file": false,
                    "notice": true,
                })
            );

            $(".confirmation-chat-modal").hide();
        });
        $("#confirmation-of-name").click(function () {
            newChatName = document.querySelector('#chatName').value;
            var noticemsg = $("#myself").val() + " has changed the chatname to " + newChatName + "."
            socket.send(
                JSON.stringify({
                    command: "edit",
                    room: editroom,
                    newName: newChatName,
                })
            );
            socket.send(
                JSON.stringify({
                    "command": "send",
                    "room": roomId,
                    "message": noticemsg,
                    "from_user": $("#myself").val(),
                    "file": false,
                    "notice": true,
                })
            );

            $('input[name=new-chat-name]').val('');
            $(".edit-chat-modal").hide();
        });
        $("#exit-member-removal").click(function () {
            $(".confirmation-modal").hide();

        })
        $("#reverse").click(function () {
            $(".confirmation-chat-modal").hide();
        })
        $("#cancel-name").click(function () {
            $(".edit-chat-modal").hide();
        })
        $("#submit-users").on('click', function () {
            let arrayofnewusers = [];
            var noticemsg;
            arrayofnewusers = JSON.parse($("#user-input").val());
            for (var i = 0; i < arrayofnewusers.length; i++) {
                var el = arrayofnewusers[i];
                arrayofusers[i] = el.name;
                if (arrayofnewusers.length < 2) {
                    noticemsg = $("#myself").val() + " has added " + el.name + " to the chat."
                }
                else {
                    noticemsg = $("#myself").val() + " has added " + el.name + ", to the chat."
                }
            }
            socket.send(
                JSON.stringify({
                    command: "add",
                    room: roomId,
                    newUsers: JSON.parse($("#user-input").val()),
                })
            );
            socket.send(
                JSON.stringify({
                    "command": "send",
                    "room": roomId,
                    "message": noticemsg,
                    "from_user": $("#myself").val(),
                    "file": false,
                    "notice": true,
                })
            );
            $("#members-page").hide();

        });
        $("#canc").on('click', function () {
            document.getElementById('members-page').style.display = 'none'
        });
        function roomClick() {
            let b = 0;
            xisweird = 0;

            if (ellipsisClicked == false) {


                roomId = $(this).attr("data-room-id");
                if (roomId == createroomid) {

                }
                else {
                    $(".list-of-members").empty();
                    $(".list-of-links").empty();
                    $(".list-of-files").empty();
                    $(".chat-log").empty();
                    $(".unread-break-line").hide();
                    unreadnotdisplayed = true;
                    if (joinedroom) {
                        // Leave room
                        wasclicked = true;
                        socket.send(
                            JSON.stringify({
                                command: "leave",
                                room: createroomid,
                            })
                        );

                        socket.send(
                            JSON.stringify({
                                command: "join",
                                room: roomId,
                                "wasclicked": wasclicked,
                            })
                        );

                        if (createroom == true) {
                            createroom = false;
                        }

                        var readjoinedroom = $("li[data-room-id=" + roomId + "]")[0];
                        $(readjoinedroom).removeClass("unread");





                        socket.send(
                            JSON.stringify({
                                command: "members",
                                room: roomId,
                            })
                        );

                        socket.send(
                            JSON.stringify({
                                command: "users",
                            })
                        );
                        $(this).addClass('active-room').siblings().removeClass('active-room');
                        for (var i = 0; i < avatararray.length; i++) {
                            av = avatararray[i];
                            if (av.group_id == roomId) {
                                $("#avatars").empty();
                                $("#avatars").append(av.group_avatar);
                                break;
                            }
                        }
                        showDefaultAvatar();
                        $("#title-img").show();
                        $(".user-header").show();
                        $(".user-header p").show();
                        $("#create-chat").show();
                        $("#tag-input").hide();
                        $("#users-list").hide();
                        $("#chat-name").hide();
                        $(".rightAccordion").show();
                        $(".rightPanel").show();
                        $(".title-wrap").show();


                        /*if (hideellipsis) {
                            $("[chat-dropdown-value=" + chatDropdownId + "]").hide();
                            hideellipsis = false;
                        }
                        else {
         
                        }*/
                        //empty chat log
                    } else {
                        // Join room
                        wasclicked = true;

                        if (createroom == true) {
                            createroom = false;
                        }
                        var readroom = $("li[data-room-id=" + roomId + "]")[0];
                        $(readroom).removeClass("unread");

                        $(".list-of-members").empty();
                        $(".list-of-links").empty();
                        $(".list-of-files").empty();
                        $(".chat-log").empty();

                        socket.send(
                            JSON.stringify({
                                command: "join",
                                room: roomId,
                                "wasclicked": wasclicked,
                            })
                        );

                        socket.send(
                            JSON.stringify({
                                command: "members",
                                room: roomId,
                            })
                        );

                        socket.send(
                            JSON.stringify({
                                command: "users",
                            })
                        );
                        $(this).addClass('active-room').siblings().removeClass('active-room');
                        for (var i = 0; i < avatararray.length; i++) {
                            av = avatararray[i];
                            if (av.group_id == roomId) {
                                $("#avatars").empty();
                                $("#avatars").append(av.group_avatar);
                                break;
                            }
                        }
                        showDefaultAvatar();
                        $("#title-img").show();
                        $(".user-header").show();
                        $(".user-header p").show();
                        $("#create-chat").show();
                        $("#tag-input").hide();
                        $("#users-list").hide();
                        $("#chat-name").hide();
                        $(".rightAccordion").show();
                        $(".rightPanel").show();
                        $(".title-wrap").show();


                        /*if (hideellipsis) {
                            $("[chat-dropdown-value=" + chatDropdownId + "]").hide();
                            hideellipsis = false;
                        }
                        else {
         
                        }*/
                    }
                }
            }
            else {
                ellipsisClicked = false;
            }
        }
        $(document).on('click', '.room-link', roomClick)

        // Creating Rooms

        $("#create-chat").click(function () {
            wasclicked = false;
            if (joinedroom) {
                socket.send(
                    JSON.stringify({
                        command: "leave",
                        room: roomId,
                    })
                );
            }
            /*if (hideellipsis) {
                $("[chat-dropdown-value=" + chatDropdownId + "]").hide();
                hideellipsis = false;
            }
            else {
     
            }*/
            $(".room-link").removeClass('active-room');
            $("#title-img").hide();
            $("#upload-photos-button").show();
            $(".title-wrap").hide();
            $("#create-chat").hide();
            $("#tag-input").show();
            $("#users-list").show();
            $("#chat-name").show();
            $(".chat-log").empty();
            $("#typed_msg").show();
            $(".msg_send_btn").show();
            $(".rightAccordion").hide();
            $(".rightPanel").hide();
            createroom = true;
            joinedroom = false;
            getusers();
            getallusers();
        });

        function getusers() {
            socket.send(
                JSON.stringify({
                    command: "users",
                })
            );
        }
        /*function populate() {
            for (var i = 0; i < memberlist.length; i++) {
                var el = memberlist[i];
                let avatarofwhitelist = el.avatar ? '<img class="profile-pic" src="' + el.avatar + '">' : '<div class="profile-pic-wrapper" style="display: inline; width: 10%;" data-username="' + el.name + '" data-bgcolor="' + el.default + '"></div>'
     
                whitelist_2[z] = {
     
                    "value": el.value,
                    "name": el.name,
                    "avatar": "{% static 'app/images/PngItem_4212266.png' %}",
                    "email": el.email,
                }
                z++;
            }
            showDefaultAvatar();
        }*/






        // Helpful debugging
        socket.onopen = function () {
            console.log("Connected to chat socket");
            socketopen = true;
            if (socketopen) {
                console.log("disconnected modal hidden")
                $(".Disconnected-modal").hide();
                socket.send(
                    JSON.stringify({
                        "command": "rooms",
                    })
                );
                /*socket.send(
                    JSON.stringify({
                        "command": "was_connected",
                        "user": $("#myself").val(),
                    })
                );*/
                if (roomId) {
                    //give room you were in active class and join it
                    let activeroom = $("li[room-link=" + roomId + "]")[0];
                    wasclicked = false;
                    socket.send(
                        JSON.stringify({
                            command: "join",
                            room: roomId,
                            "wasclicked": wasclicked,
                        })
                    );
                    $(activeroom).addClass("active-room");
                }
            }
        };
        socket.onclose = function () {
            socketopen = false;
            console.log("Disconnected from chat socket");
            if (!socketopen) {
                console.log("disconnected modal shown")
                $(".Disconnected-modal").show();
                $(".rooms").empty();
            }
        };

        function fillarray2() {

            var input = document.querySelector('input[name=tags-manual-suggestions]');
            // init Tagify script on the above inputs
            input.addEventListener('change', onChange)

            function onChange(e) {
                if (input.value != 0) {
                    document.getElementById('submit-users').disabled = false;
                } else {
                    document.getElementById('submit-users').disabled = true;
                }
            }

            tagify = new Tagify(input, {
                tagTextProp: 'name', // very important since a custom template is used with this property as text
                templates: {
                    tag: function (tagData) {
                        try {
                            return `
                                <tag title="${tagData.email}"
                                    contenteditable='false'
                                    spellcheck='false'
                                    tabIndex="-1"
                                    class="tagify__tag ${tagData.class ? tagData.class : ""}"
                                    ${this.getAttributes(tagData)}>
                                <x title='' class='tagify__tag__removeBtn' role='button' aria-label='remove tag'></x>
                                <div>
                                    <div class='tagify__tag__avatar-wrap'>
                                        <img onerror="this.style.visibility='hidden'" src="${tagData.avatar}">
                                    </div>
                                    <span class='tagify__tag-text'>${tagData.name}</span>
                                </div>
                                </tag>`
                        }
                        catch (err) { }
                    },

                    dropdownItem: function (tagData) {
                        try {
                            let avatarurl = "";
                            for (var i = 0; i < memberlist.length; i++) {
                                var el = memberlist[i];
                                if (el.value == tagData.value) {
                                    avatarurl = el.avatar
                                    break;
                                }
                            }
                            if (tagData.disabled) {
                                let avatarurl = "";
                                for (var i = 0; i < memberlist.length; i++) {
                                    var el = memberlist[i];
                                    if (el.value == tagData.value) {
                                        avatarurl = el.avatar
                                        break;
                                    }
                                }
                                return `
                               <div ${this.getAttributes(tagData)}
                                   style="display: none;"
                                   class='tagify__dropdown__item ${tagData.class ? tagData.class : ""}'
                                   tabindex="0"
                                   role="option">
                                   ${tagData.avatar ? `
                                   <div class='tagify__dropdown__item__avatar-wrap'>
                                       <img class='tagify__dropdown__item__avatar-wrap' onerror="this.style.visibility='hidden'" src="${avatarurl}">
                                   </div>` : ''
                                    }
                                   <strong>${tagData.name}</strong>
                                   <span>${tagData.email}</span>
                               </div>
                           `
                            }
                            else {
                                return `
                               <div ${this.getAttributes(tagData)}
                                   class='tagify__dropdown__item ${tagData.class ? tagData.class : ""}'
                                   tabindex="0"
                                   role="option">
                                   ${tagData.avatar ? `         
                                    <div class='tagify__dropdown__item__avatar-wrap'>
                                    <div class="profile-pic-wrapper">
                                    <img onerror="this.style.visibility='hidden'" src="${avatarurl}">
                                    <div online-link-id="${tagData.value}"class="online_icon"></div>
                                    </div>
                                   </div>` : `<div class='tagify__dropdown__item__avatar-wrap'>
                        <div class="profile-pic-wrapper" data-username="${tagData.name}" data-bgcolor="${tagData.default}">
                        </div>
                        <div online-link-id="${tagData.value}"class="online_icon"></div>
                    </div>`
                                    }
                                   <strong>${tagData.name}</strong>
                                   <span>${tagData.email}</span>
                               </div>
                           `
                            }
                        }
                        catch (err) { }
                    }
                },

                dropdown: {
                    position: "manual",
                    maxItems: Infinity,
                    enabled: 0,
                    searchKeys: ['id', 'email'],  // very important to set by which keys to search for suggesttions when typing
                    classname: "customSuggestionsList"
                },
                enforceWhitelist: true,
                whitelist: []
            })

            //var whitelist_1 = [{ "value": 2, "name": "bannas", "avatar": "{% static 'app/images/PngItem_4212266.png' %}", "email": "oh" }];

            tagify.settings.whitelist = whitelist_2;


            tagify.on("dropdown:show", onSuggestionsListUpdate)
                .on("dropdown:hide", onSuggestionsListHide)
                .on('dropdown:scroll', onDropdownScroll)

            renderSuggestionsList()

            // ES2015 argument destructuring
            function onSuggestionsListUpdate({ detail: suggestionsElm }) {
                //console.log(suggestionsElm)
            }

            function onSuggestionsListHide() {
                //console.log("hide dropdown")
            }

            function onDropdownScroll(e) {
                //console.log(e.detail)
            }

            // https://developer.mozilla.org/en-US/docs/Web/API/Element/insertAdjacentElement
            function renderSuggestionsList() {
                tagify.dropdown.show.call(tagify) // load the list
                tagify.DOM.scope.parentNode.appendChild(tagify.DOM.dropdown)
            }



            $("#canc").on('click', tagify.removeAllTags.bind(tagify));


            $("#submit-users").on('click', tagify.removeAllTags.bind(tagify));




        }


        function getallusers() {
            var inputElm = document.querySelector('input[name=users-list-tags]');

            inputElm.addEventListener('change', onChangeCreate)

            function onChangeCreate(e) {
                if (inputElm.value != 0) {
                    createconfirmation = 1;
                } else {
                    createconfirmation = 0;
                }
            }
            function tagTemplate(tagData) {
                let avatarurl = "";
                for (var i = 0; i < memberlist.length; i++) {
                    var el = memberlist[i];
                    if (el.value == tagData.value) {
                        avatarurl = el.avatar
                        break;
                    }
                }
                return `
                    <tag title="${tagData.email}"
                            contenteditable='false'
                            spellcheck='false'
                            tabIndex="-1"
                            class="tagify__tag ${tagData.class ? tagData.class : ""}"
                            ${this.getAttributes(tagData)}>
                        <x title='' class='tagify__tag__removeBtn' role='button' aria-label='remove tag'></x>
                        <div>
                            <div class='tagify__tag__avatar-wrap'>
                                <img onerror="this.style.visibility='hidden'" src="${avatarurl}">
                            </div>
                            <span class='tagify__tag-text'>${tagData.name}</span>
                        </div>
                    </tag>
                    `
            }

            function suggestionItemTemplate(tagData) {
                let avatarurl = "";
                for (var i = 0; i < memberlist.length; i++) {
                    var el = memberlist[i];
                    if (el.value == tagData.value) {
                        avatarurl = el.avatar
                        break;
                    }
                }
                tagdropdown = `
                               <div ${this.getAttributes(tagData)}
                                   class='tagify__dropdown__item ${tagData.class ? tagData.class : ""}'
                                   tabindex="0"
                                   role="option">
                                   ${tagData.avatar ? `         
                                    <div class='tagify__dropdown__item__avatar-wrap'>
                                    <img onerror="this.style.visibility='hidden'" src="${avatarurl}">
                                    <div online-link-id="${tagData.value}"class="online_icon"></div>
                                   </div>` : `<div class='tagify__dropdown__item__avatar-wrap' data-username="${tagData.name}" data-bgcolor="${tagData.default}">
                        <div online-link-id="${tagData.value}"class="online_icon"></div>
                    </div>`
                    }
                                   <strong>${tagData.name}</strong>
                                   <span>${tagData.email}</span>
                               </div>
                           `
                showTagAvatars();
                return tagdropdown;
            }

            // initialize Tagify on the above input node reference
            var tagify2 = new Tagify(inputElm, {
                tagTextProp: 'name', // very important since a custom template is used with this property as text
                enforceWhitelist: true,
                skipInvalid: true, // do not remporarily add invalid tags

                dropdown: {
                    closeOnSelect: true,
                    enabled: 0,
                    classname: 'users-list',
                    searchKeys: ['name', 'email']  // very important to set by which keys to search for suggesttions when typing
                },
                templates: {
                    tag: tagTemplate,
                    dropdownItem: suggestionItemTemplate
                },

                whitelist: [
                    {% for user in users %}
                    {
                    "value": "{{ user.pk }}",
                    "name": "{{user.username}}",
                    "avatar2": "{% static 'app/images/PngItem_4212266.png' %}",
                    "avatar": "{{user.avatar}}",
                    "email": "{{user.email}}",
                    "default": "{{user.bgColor}}"
                },
                {% endfor %}
                    ]
    })

    /*tagify2.on('dropdown:show dropdown:updated', onDropdownShow)


    function onDropdownShow(e) {
        var dropdownContentElm = e.detail.tagify2.DOM.dropdown.content;

    }*/

    $(".sending-form").on("submit", tagify2.removeAllTags.bind(tagify2));

            }
    })
</script>



</html>
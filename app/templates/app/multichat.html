<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    {% load static %}
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css" />
    <link rel="stylesheet" href="{% static 'app/content/tagify.css' %}" />
    <link rel="stylesheet" href="{% static 'app/content/tags.css' %}" />
    <link rel="stylesheet" href="{% static 'app/content/chatPage.css' %}" />
    <link rel="stylesheet"
        href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" type="text/css"
        rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'app/content/style.css' %}" />

    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="{% static 'app/scripts/jquery.js' %}"></script>

    <script src="{% static 'app/scripts/jquery.ui.widget.js' %}"></script>
    <script src="{% static 'app/scripts/jquery.iframe-transport.js' %}"></script>
    <script src="{% static 'app/scripts/jquery.fileupload.js' %}"></script>

    <script src="{% static 'app/scripts/tag.js' %}"></script>
    <script src="{% static 'app/scripts/jQuery.tagify.min.js' %}"></script>
    <script>
        // if IE, add IE tagify's polyfills
        !(function (d) {
            if (!d.currentScript) {
                var s = d.createElement("script");
                s.src = "{% static 'app/scripts/tagify.polyfills.min.js' %}";
                d.head.appendChild(s);
            }
        })(document);
    </script>
    <style>
        body {
            margin: 40px 10px;
            padding: 0;
            font-family: Helvetica;
            font-size: 14px;
        }
    </style>
</head>

<!-- Make it autocomplete or somehting like that so not all users
show in the dropdown. Maybe an onChange functionality. Make it so dropdown
is empty when first clicked -->

<!--
    <div id="members-page">
        <div id="members-page-content">
            <i class="las la-window-close" style="right:0; height: 10%; float:right; position: relative;"
                onclick="document.getElementById('members-page').style.display='none'" id="close"
                title="Close Modal"></i>
            <div class="column-two">
                <ul class="member-list">
                    <div class="column-one">
                        <li class="list-of-members"></li>
                    </div>
                    <div class="column-three">
                        <li class="remove-buttons"></li>
                    </div>
                </ul>
            </div>

        </div>
    </div>
-->

<body>
    <div class="sidebar">


        <div class="sidebar-menu">
            <ul>
                <li>
                    <a href="{% url 'dashboard' %}">
                        <span id="fist-element" class="las la-home"></span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'resourcedirectory' %}">
                        <span class="las la-book"></span>
                    </a>
                </li>
                <li>
                    <a class="active" href="{% url 'multichat' %}">
                        <span class="las la-comment-alt"></span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'clientlist' %}">
                        <span class="las la-user-friends"></span>
                    </a>
                </li>
                <li>
                    <a href="">
                        <span class="las la-plus-circle"></span>
                    </a>
                </li>
            </ul>
        </div>
    </div>



    <header class="dash-header">

        <div class="sidebar-header">
            <span id="sidebar-toggle" class="las la-bars"></span>
        </div>
        <div id="leftside">
            <div class="search-wrapper">
                <span class="las la-search"></span>
                <input type="search" placeholder="Search here" />
            </div>
            <div class="vl"></div>
            <div class="dropdown">
                <div class="user-wrapper">
                    <div class="profile-pic-wrapper" data-username="{{user.username}}" data-bgcolor="{{user.bgColor}}">
                        {% if user.avatar %}
                        <img class="profile-pic" src="{{user.avatar.url}}">
                        {% endif %}
                    </div>
                    <i id="caret-icon" style=font-size:25px;color:white;float:right; class="las la-angle-down"></i>
                    <div class="dropdown-content">
                        <div id="usermenu">
                            <h3>{{ user.username }}</h3>
                            <h4>Caseworker</h4>
                        </div>
                        <a href="{% url 'logout' %}">Log out</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="main-content">
        <div class="chat-container">
            <div class="left-panel">
                <div class="left-panel-header">
                    <div class="search-container">
                        <input type="text" placeholder="Search.." name="search">
                        <button type="submit"><i class="fa fa-search"></i></button>
                    </div>
                </div>
                <div class="rooms-container">
                    <div class="rooms">
                        {% for room in rooms %}
                        <li class="room-link" data-room-id="{{ room.id }}">{{ room }}</li>
                        {% empty %}
                        <p>
                            No chat rooms.
                        </p>
                        {% endfor %}
                    </div>
                </div>
                <div class="creating-chat-section">
                    <button style="margin-top: 3.3%;" id="create-chat">create new chat</button><br />
                </div>
            </div>
            <div class="middle-panel">
                <div class="user-header">
                    <div>
                        <h4 style="margin-top: 3%;"></h4><button class="showMembers"
                            style="display: none;">members</button>
                    </div>
                    <button class="add-user" style="display: none;">Add User</button>


                </div>
                <section id="users-list" style="display: none; position: relative">
                    <p>
                        <input id="tag-input" style="display: none; position: relative" name="users-list-tags" /><button
                            style="display: none; position: relative" id="create-group">
                            Create
                        </button>
                    </p>
                </section>
                <div class="chat-log"></div>
                <div class="input-section">
                    <input id="fileupload" type="file" name="file" multiple style="display: none"
                        data-url="{% url 'upload' %}" data-form-data='{"csrfmiddlewaretoken": "{{ csrf_token }}"}' />
                    <form class="sending-form">
                        <input type="text" style="display: none;margin-top: 4%;" id="typed_msg"
                            placeholder="Type a message" required />
                        <i id="upload-photos-button" class="las la-paperclip"
                            style="display:none;cursor:pointer;font-size:25px;margin-top: 5%;"></i>
                        <button class="msg_send_btn" style="display: none;" type="submit"><i style="color: white;"
                                class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
                    </form>
                </div>
            </div>
            <div class="right-panel">
                <button class="rightAccordion" style="display: none;">Members</button>
                <div class="rightPanel">
                    <ul class="right-btn-group">
                        <li class="list-of-members"></li>
                    </ul>
                </div>
                <button class="rightAccordion">Files</button>
                <div class="rightPanel">
                    <div class="right-btn-group">
                        <button>File 1</button>
                        <button>File 2</button>
                        <button>File 3</button>
                    </div>
                </div>

                <button class="rightAccordion">Links</button>
                <div class="rightPanel">
                    <div class="right-btn-group">
                        <button>Link 1</button>
                        <button>Link 2</button>
                        <button>Link 3</button>
                    </div>
                </div>
                <script src="{% static 'app/scripts/rightChat.js' %}"></script>
            </div>
        </div>
    </div>
</body>
<input id="myself" type="hidden" value="{{request.user.username}}" />
<br />




<audio id="chatAudio">
    <source src="{% static 'app/audio/notification.mp3' %}" type="audio/mpeg">
</audio>
<script src="https://cdnjs.cloudflare.com/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.min.js"
    integrity="sha512-B4skI5FiLurS86aioJx9VfozI1wjqrn6aTdJH+YQUmCZum/ZibPBTX55k5d9XM6EsKePDInkLVrN7vPmJxc1qA=="
    crossorigin="anonymous"></script>
<script src="{% static 'app/scripts/default_avatar.js' %}"></script>
<script>

    $("#caret-icon").on('click', function () {
        $(this).toggleClass('la-angle-up la-angle-down');
        $(".dropdown-content").toggle('show hide');
    })

    $("#sidebar-toggle").on('click', function () {
        $(".sidebar").toggle('show hide');
    })
</script>
<script>
    let roomId = false;

    $(function () {
        // Correctly decide between ws:// and wss://
        var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        var ws_path = ws_scheme + "://" + window.location.host + "/chat/stream/";
        console.log("Connecting to " + ws_path);

        //var socket = new WebSocket(ws_path);
        var socket = new ReconnectingWebSocket(ws_path);
        var roomName = null;
        $(".sending-form").on("submit", function () {

            event.preventDefault();
            if (roomName) {
                socket.send(
                    JSON.stringify({
                        "command": "send",
                        "room": roomName,
                        "message": document.querySelector('#typed_msg').value
                    })
                );
                $("#typed_msg").empty();
                return false;
            }
        });

        $("#upload-photos-button").click(function () {
            $("#fileupload").click();
        });

        /* 2. INITIALIZE THE FILE UPLOAD COMPONENT */
        $("#fileupload").fileupload({
            dataType: 'json',
            done: function (e, data2) {  /* 3. PROCESS THE RESPONSE FROM THE SERVER */
                if (data2.result.is_valid) {
                    /*send file to recipient and add a progress bar*/
                    console.log("file uploaded")
                    const message = 'file <a style=word-wrap:break-word; href="' + data2.result.url + '" target="_blank">' + data2.result.name + '</a>'
                    if (roomName) {
                        socket.send(
                            JSON.stringify({
                                "command": "send",
                                "room": roomName,
                                "message": message
                            })
                        );
                    }
                }

            }
        });

        // Handle incoming messages
        socket.onmessage = function (message) {
            console.log("message", message)
            console.log("Got websocket message " + message.data)
            var data = JSON.parse(message.data);
            console.log("data", data)
            // Handle errors
            if (data.error) {
                alert(data.error);
                return;
            }

            message = data.message


            // Handle joining
            if (data.join) {
                console.log("Joining room " + data.join);
                roomName = data.join;


                //   console.log("myself value: " + $("#myself").val() + "data.from_user value: " + message.from_user)

                // Hook up send button to send a message




                //hook up sending files
                /* 1. OPEN THE FILE EXPLORER WINDOW */


                $(".user-header h4").html(data.title);

                // Handle leaving
            } else if (data.leave) {
                console.log("Leaving room " + data.leave);
                roomName = null;
                $("#room-" + data.leave).remove();
                $(".user-header").empty();
                $(".chat-log").empty();

                // Handle getting a message
            } else if (data.message || data.msg_type != 0) {
                var msgdiv = $(".chat-log");
                var ok_msg = "";



                // msg types are defined in chat/settings.py
                // Only for demo purposes is hardcoded, in production scenarios, consider call a service.
                const LEFT_ROOM = 5;
                switch (data.msg_type) {
                    case 0:
                        // Message

                        let text = (data.message.text) ? data.message.text : data.message;
                        let user = (data.message.from_user) ? data.message.from_user : data.username;
                        const cssClass = $("#myself").val() == user ? 'outgoing' : 'incoming';

                        ok_msg =
                            `<div class='${cssClass}''>` +
                            `<span class='username'>` +
                            user +
                            `: </span>` +
                            `<span class='text' > ` +
                            text +
                            `</span> ` +
                            `</div> `;


                        break;

                    case 1:
                        // Warning / Advice messages
                        ok_msg =
                            "<div class='contextual-message text-warning'>" +
                            data.message +
                            "</div>";
                        break;
                    case 2:
                        // Alert / Danger messages
                        ok_msg =
                            "<div class='contextual-message text-danger'>" +
                            data.message +
                            "</div>";
                        break;
                    case 3:
                        // "Muted" messages
                        ok_msg =
                            "<div class='contextual-message text-muted'>" +
                            data.message +
                            "</div>";
                        break;
                    /* case 4:
                         // User joined room
                         ok_msg =
                             "<div class='contextual-message text-muted'>" +
                             data.username +
                             " joined the room!" +
                             "</div>";
                         break;
                     case LEFT_ROOM:
                         // User left room
                         ok_msg =
                             "<div class='contextual-message text-muted'>" +
                             data.username +
                             " left the room!" +
                             "</div>";
                         break;*/
                    case "created":
                        ok_msg =
                            $(".rooms").append(
                                `<li class="room-link" data-room-id="${data.room}"> ${data.name}</li>`
                            );

                        break;
                    case "room_exists":
                        $("li[data-room-id=" + data.room_id + "]").click();
                        ok_msg =
                            "<div class='contextual-message text-muted'>room already exists</div>";
                        break;

                    case "get_members":
                        var people = data.member


                        // $(".avatar-list").append(
                        //`<li><img src="" alt="user" class="profile-photo-lg"></li>`
                        // );

                        $(".list-of-members").append(
                            `       <li>
            		        <h4><a href="#" class="profile-link">${people.username}</a></h4>
        	            </li>`

                        );

                        /*$(".remove-buttons").append(
                            `<li style="padding-bottom: 18px;"><button data-id="${people.id}" class="remove-user">Remove User</button>
                                </li>`      //attach user id to remove button
                        );*/

                        break;

                    default:
                        console.log("Unsupported message type!");
                        return;
                }

                $(".chat-log").html();
                if (data.msg_type != "created")
                    msgdiv.append(ok_msg);

                msgdiv.scrollTop(msgdiv.prop("scrollHeight"));
            } else {
                console.log("Cannot handle message!");
            }
        };


        // Says if we joined a room or not by if there's a div for it
        inRoom = function (roomId) {
            return $("#room-" + roomId).length > 0;
        };

        // Room join/leave

        /* -Show all saved messages when joining a room
                    -Make it if already in that room either do nothing or reload that room
                    -if not in that room leave current room, if in one, then join the
                    room that was clicked on
                    -If not in room when a message comes in give it an unread class*/


        function roomClick() {
            roomId = $(this).attr("data-room-id");
            if (inRoom(roomId)) {
                // Leave room

                $(this).removeClass("joined");
                socket.send(
                    JSON.stringify({
                        command: "leave",
                        room: roomId,
                    })
                );
                $(".chat-log").empty();
                //empty chat log
            } else {
                // Join room

                $(this).addClass("joined");
                socket.send(
                    JSON.stringify({
                        command: "join",
                        room: roomId,
                    })
                );


                $(".list-of-members").empty();

                socket.send(
                    JSON.stringify({
                        command: "members",
                        room: roomId,
                    })
                );


                $("#typed_msg").show();
                $("#upload-photos-button").show();
                $(".msg_send_btn").show();
                $(".user-header").show();
                $("#create-chat").show();
                $("#tag-input").hide();
                $("#users-list").hide();
                $("#create-group").hide();
                $(".chat-log").empty();
                $(".rightAccordion").show();

            }
        }
        $(document).on('click', '.room-link', roomClick)



        // Creating Rooms

        $("#create-chat").click(function () {
            if (roomId) {
                if (inRoom(roomId)) {
                    // Leave room

                    $(this).removeClass("joined");
                    socket.send(
                        JSON.stringify({
                            command: "leave",
                            room: roomId,
                        })
                    );
                }
            }
            $("#upload-photos-button").hide();
            $(".user-header").hide();
            $("#create-chat").hide();
            $("#tag-input").show();
            $("#users-list").show();
            $("#create-group").show();
            $(".chat-log").empty();
            $("#typed_msg").hide();
            $(".msg_send_btn").hide();
            $(".rightAccordion").hide();
        });

        $("#create-group").click(function () {
            socket.send(
                JSON.stringify({
                    command: "create",
                    newUsers: JSON.parse($("#tag-input").val()),
                })
            );

            $("#tag-input").hide();
            $("#users-list").hide();
            $("#tag-input").empty();
            $("#create-group").hide();

            //join the room that was just created


            $("li[data-room-id=" + data.room_id + "]").click();

            $(".msg_send_btn").show();
            $(".user-header").show();
            $("#create-chat").show();
            $("#create-chat").show();
            $("#typed_msg").show();
            $("#upload-photos-button").show();
            $(".rightAccordion").show();
        });

        // Helpful debugging
        socket.onopen = function () {
            console.log("Connected to chat socket");
        };
        socket.onclose = function () {
            console.log("Disconnected from chat socket");
        };
    });
</script>

<script data-name="users-list">
    // https://www.mockaroo.com/
    (function () {
        var x = 1
        var inputElm = document.querySelector('input[name=users-list-tags]');

        function tagTemplate(tagData) {
            return `
        <tag title="${tagData.email}"
                contenteditable='false'
                spellcheck='false'
                tabIndex="-1"
                class="tagify__tag ${tagData.class ? tagData.class : ""}"
                ${this.getAttributes(tagData)}>
            <x title='' class='tagify__tag__removeBtn' role='button' aria-label='remove tag'></x>
            <div>
                <div class='tagify__tag__avatar-wrap'>
                    <img onerror="this.style.visibility='hidden'" src="${tagData.avatar}">
                </div>
                <span class='tagify__tag-text'>${tagData.name}</span>
            </div>
        </tag>
    `
        }

        function suggestionItemTemplate(tagData) {
            return `
        <div ${this.getAttributes(tagData)}
            class='tagify__dropdown__item ${tagData.class ? tagData.class : ""}'
            tabindex="0"
            role="option">
            ${tagData.avatar ? `
            <div class='tagify__dropdown__item__avatar-wrap'>
                <img onerror="this.style.visibility='hidden'" src="${tagData.avatar}">
            </div>` : ''
                }
            <strong>${tagData.name}</strong>
            <span>${tagData.email}</span>
        </div>
    `
        }

        // initialize Tagify on the above input node reference
        var tagify = new Tagify(inputElm, {
            tagTextProp: 'name', // very important since a custom template is used with this property as text
            enforceWhitelist: true,
            skipInvalid: true, // do not remporarily add invalid tags
            dropdown: {
                closeOnSelect: false,
                enabled: 0,
                classname: 'users-list',
                searchKeys: ['name', 'email']  // very important to set by which keys to search for suggesttions when typing
            },
            templates: {
                tag: tagTemplate,
                dropdownItem: suggestionItemTemplate
            },

            whitelist: [
                {% for user in users %}
        {
                "value": "{{ user.pk }}",
                "name": "{{user.username}}",
                "avatar": "{% static 'app/images/PngItem_4212266.png' %}",
                "email": "{{user.email}}"
            },
            {% endfor %}    
    ]
    
})

    tagify.on('dropdown:show dropdown:updated', onDropdownShow)


    function onDropdownShow(e) {
        var dropdownContentElm = e.detail.tagify.DOM.dropdown.content;

    }



}) ()
</script>

</html>


{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static "app/content/multichat.css" %}" type="text/css" media="screen" />
<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<link rel="stylesheet" href="{% static 'app/content/instantmessage.css' %}" />
<link rel="stylesheet" href="{% static 'app/content/tagify.css' %}" />
<link rel="stylesheet" href="{% static 'app/content/tags.css' %}">
<link rel="stylesheet" href="{% static 'app/content/chat.css' %}">
<link rel="stylesheet"
    href="https://maxst.icons8.com/vue-static/landings/line-awesome/font-awesome-line-awesome/css/all.min.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" type="text/css"
    rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{% static 'app/content/bootstrap.min.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'app/content/bootstrap.css' %}" />

<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="{% static 'app/scripts/jquery.js' %}"></script>

<script src="{% static 'app/scripts/tag.js' %}"></script>
<script src="{% static 'app/scripts/jQuery.tagify.min.js' %}"></script>

<script>
    // if IE, add IE tagify's polyfills
    !function (d) {
        if (!d.currentScript) {
            var s = d.createElement('script');
            s.src = "{% static 'app/scripts/tagify.polyfills.min.js' %}";
            d.head.appendChild(s);
        }
    }(document)
</script>

{% endblock %}

{% block title %}MultiChat Example{% endblock %}
{% block header_text %}MultiChat Example{% endblock %}

{% block content %}

<section id="users-list" style=display:none;position:relative;>

     <p><input id="tag-input" style=display:none;position:relative; name='users-list-tags'><button style=display:none;position:relative; id="create-group"> Create </button></p>


    </section>
    <div className="row">
        <div className="col-md-2">
    <ul class="rooms">
        {% for room in rooms %}
            <li class="room-link" data-room-id="{{ room.id }}">{{ room }}</li>
        {% empty %}
            <p class="empty">No chat rooms defined. Maybe make some in the <a href="{% url 'admin:index' %}">admin</a>?</p>
        {% endfor %}
    </ul>
</div>
<div className="col-md-10">
    <div id="chats"></div>    
    </div>
    </div>
    <button id='create-chat'>create new chat</button><br>

{% endblock %}


{% block scripts %}
<input id="myself" type="hidden" value="{{request.user.username}}" />

<br>
    <script>
        $(function () {
            // Correctly decide between ws:// and wss://
            var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
            var ws_path = ws_scheme + '://' + window.location.host + "/chat/stream/";
            console.log("Connecting to " + ws_path);
            
            var socket = new WebSocket(ws_path);
            //var socket = new ReconnectingWebSocket(ws_path);

            // Handle incoming messages
            socket.onmessage = function (message) {
                // Decode the JSON
                console.log("Got websocket message " + message.data);
                var data = JSON.parse(message.data);
                // Handle errors
                if (data.error) {
                    alert(data.error);
                    return;
                }




                //chat window

                // Only one chat room that will be emptied when entering new rooms
                // find a way to get only one chat room
                $("#chats").show(roomdiv);





                // Handle joining
                if (data.join) {
                    console.log("Joining room " + data.join);
                    var roomdiv = $(
                            "<div class='room' id='room-" + data.join + "'>" +
                            "<h2>" + data.title + "</h2>" +
                            "<div class='messages'></div>" +
                            "<form><input><button>Send</button></form>" +
                            "</div>"
                    );
                    // Hook up send button to send a message
                    roomdiv.find("form").on("submit", function () {
                        socket.send(JSON.stringify({
                            "command": "send",
                            "room": data.join,
                            "message": roomdiv.find("input").val()
                        }));
                        roomdiv.find("input").val("");
                        return false;
                    });


                    
                    
                    // Handle leaving
                } else if (data.leave) {
                    console.log("Leaving room " + data.leave);
                    $("#room-" + data.leave).remove();
                    // Handle getting a message
                } else if (data.message || data.msg_type != 0) {
                    var msgdiv = $("#room-" + data.room + " .messages");
                    var ok_msg = "";
                    
                    
                    
                    
                    // msg types are defined in chat/settings.py
                    // Only for demo purposes is hardcoded, in production scenarios, consider call a service.
                    switch (data.msg_type) {
                        case 0:
                            // Message
                            ok_msg = "<div class='message'>" +
                                    "<span class='username'>" + data.username + "</span>" +
                                    "<span class='body'>" + data.message + "</span>" +
                                    "</div>";
                            break;
                        case 1:
                            // Warning / Advice messages
                            ok_msg = "<div class='contextual-message text-warning'>" + data.message +
                                    "</div>";
                            break;
                        case 2:
                            // Alert / Danger messages
                            ok_msg = "<div class='contextual-message text-danger'>" + data.message +
                                    "</div>";
                            break;
                        case 3:
                            // "Muted" messages
                            ok_msg = "<div class='contextual-message text-muted'>" + data.message +
                                    "</div>";
                            break;
                        case 4:
                            // User joined room
                            ok_msg = "<div class='contextual-message text-muted'>" + data.username +
                                    " joined the room!" +
                                    "</div>";
                            break;
                        case 5:
                            // User left room
                            ok_msg = "<div class='contextual-message text-muted'>" + data.username +
                                    " left the room!" +
                                    "</div>";
                            break;
                        default:
                            console.log("Unsupported message type!");
                            return;
                    }
                    msgdiv.append(ok_msg);

                    msgdiv.scrollTop(msgdiv.prop("scrollHeight"));
                } else {
                    console.log("Cannot handle message!");
                }
            };


            // Says if we joined a room or not by if there's a div for it
            inRoom = function (roomId) {
                return $("#room-" + roomId).length > 0;
            };


            // Room join/leave

            // Show all saved messages when joining a room
            //if already in that room either do nothing or reload that room
            //if not in that room leave current room if in one then join the
            //room that was clicked on

            $("li.room-link").click(function () {
                roomId = $(this).attr("data-room-id");
                if (inRoom(roomId)) {
                    // Leave room
                    $(this).removeClass("joined");
                    socket.send(JSON.stringify({
                        "command": "leave",
                        "room": roomId
                    }));
                } else {
                    // Join room
                    $(this).addClass("joined");
                    socket.send(JSON.stringify({
                        "command": "join",
                        "room": roomId
                    }));
                }
            });
            
            // Creating Room

                // if room created reset all back to the way it was and add room to list
                // if no valid input in tag create button is disabled/won't create
                /* if statement and maybe while statement that will cycle through room names or id's and compare to what
                 was entered in input and compare it to room names until it doesn't match room will not be created 
                or if create button is pressed and room already exists will swap to that room*/

            
            /* Because the name has to be unique a room with the same name
                can't be created so if we can return an error message or some
                signifer saying room was not created it should be possible to make
                a command to do a remote click on that room with the name that
                already exists
            */

            $("#create-chat").click(function () {
                if (inRoom(roomId)) {
                    // Leave room
                    $(this).removeClass("joined");
                    socket.send(JSON.stringify({
                        "command": "leave",
                        "room": roomId
                    }));
                }

                $("#create-chat").hide();
                $("#tag-input").show();
                $("#create-group").show();

                socket.send(JSON.stringify({
                        "command": "create",
                        "newUsers": JSON.parse($("#tag-input").val()),
                    }));


            })

            // Helpful debugging
            socket.onopen = function () {
                console.log("Connected to chat socket");
            };
            socket.onclose = function () {
                console.log("Disconnected from chat socket");
            }
        });

        
    </script>
       <script data-name="users-list">
        // https://www.mockaroo.com/
        (function () {
            var x = 1
            var inputElm = document.querySelector('input[name=users-list-tags]');

            function tagTemplate(tagData) {
                return `
                <tag title="${tagData.email}"
                        contenteditable='false'
                        spellcheck='false'
                        tabIndex="-1"
                        class="tagify__tag ${tagData.class ? tagData.class : ""}"
                        ${this.getAttributes(tagData)}>
                    <x title='' class='tagify__tag__removeBtn' role='button' aria-label='remove tag'></x>
                    <div>
                        <div class='tagify__tag__avatar-wrap'>
                            <img onerror="this.style.visibility='hidden'" src="${tagData.avatar}">
                        </div>
                        <span class='tagify__tag-text'>${tagData.name}</span>
                    </div>
                </tag>
            `
            }

            function suggestionItemTemplate(tagData) {
                return `
                <div ${this.getAttributes(tagData)}
                    class='tagify__dropdown__item ${tagData.class ? tagData.class : ""}'
                    tabindex="0"
                    role="option">
                    ${tagData.avatar ? `
                    <div class='tagify__dropdown__item__avatar-wrap'>
                        <img onerror="this.style.visibility='hidden'" src="${tagData.avatar}">
                    </div>` : ''
                    }
                    <strong>${tagData.name}</strong>
                    <span>${tagData.email}</span>
                </div>
            `
            }

            // initialize Tagify on the above input node reference
            var tagify = new Tagify(inputElm, {
                tagTextProp: 'name', // very important since a custom template is used with this property as text
                enforceWhitelist: true,
                skipInvalid: true, // do not remporarily add invalid tags
                dropdown: {
                    closeOnSelect: false,
                    enabled: 0,
                    classname: 'users-list',
                    searchKeys: ['name', 'email']  // very important to set by which keys to search for suggesttions when typing
                },
                templates: {
                    tag: tagTemplate,
                    dropdownItem: suggestionItemTemplate
                },

                whitelist: [
                    {% for user in users %}
                {
                    "value": {{ user.pk }},
                    "name": "{{user.username}}",
                    "avatar": "{{user.avatar}}",
                    "email": "{{user.email}}"
                },
                    {% endfor %}    
            ]
            
        })

        tagify.on('dropdown:show dropdown:updated', onDropdownShow)


        function onDropdownShow(e) {
            var dropdownContentElm = e.detail.tagify.DOM.dropdown.content;

        }
        
        

        }) ()
    </script>
{% endblock %}
